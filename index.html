<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>쿠폰 관리 시스템</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { margin-bottom: 30px; }
    .coupon-form, .usage-form, .filters { margin-bottom: 20px; padding:15px; border:1px solid #ccc; border-radius:5px; }
    label { display: block; margin-top: 10px; }
    input[type="text"], input[type="date"], input[type="number"], select {
      width: calc(100% - 22px);
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    input[type="checkbox"] { margin-top: 10px; }
    button { padding: 10px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top:15px;}
    button:hover { background-color: #45a049; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .expired { background-color: #ffdddd; color: #a00000; } /* 만료된 쿠폰 스타일 */
    .nearing-expiry { background-color: #fff0dd; color: #c57500; } /* 만료 임박 쿠폰 스타일 (예: 7일 이내) */
    .coupon-fully-used {
      text-decoration: line-through;
      color: grey;
      background-color: #f0f0f0; /* Optional: slight background change */
    }
    .coupon-fully-used button { /* Optional: disable buttons in used rows */
       pointer-events: none;
       opacity: 0.5;
    }
    .message { padding: 10px; margin-top: 10px; border-radius: 4px; }
    .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    #loading { display: none; text-align: center; padding: 20px; }

    /* 중간 크기 화면 스타일 (예: 태블릿) */
    @media (max-width: 768px) {
        .container { margin-bottom: 20px; }
    }

    /* 작은 크기 화면 스타일 (예: 모바일폰) */
    @media (max-width: 480px) {
        body {
          font-size: 14px;
          margin: 10px;
        }
        h1 { font-size: 1.5em; }
        h2 { font-size: 1.2em; }
        h3 { font-size: 1.1em; }

        input[type="text"], input[type="date"], input[type="number"], select, button {
            font-size: 1em;
            padding: 12px;
        }
        label { font-size: 0.95em; margin-top: 8px; }
        button { margin-top: 10px; }
        .table-responsive-wrapper {
            overflow-x: auto;
            width: 100%;
            margin-top: 15px;
        }
        #allCouponsTable {
           min-width: 750px; /* Adjusted for more columns */
        }
        th, td { padding: 6px; }
        #usageModal, #generalCouponUsageModal { /* Apply to both modals */
            width: 90%;
            max-width: 400px;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            max-height: 80vh;
            overflow-y: auto;
            padding: 15px;
        }
        .coupon-form, .usage-form, .filters {
          padding:10px;
          margin-bottom: 15px;
        }
    }
  </style>
</head>
<body>
  <h1>쿠폰 관리 시스템</h1>

  <div id="loading">로딩 중...</div>
  <div id="statusMessage" class="message" style="display:none;"></div>

  <!-- 새 쿠폰 입력 양식 -->
  <div class="container">
    <h2>새 쿠폰 추가</h2>
    <div class="coupon-form">
      <label for="barcode">바코드:</label>
      <input type="text" id="barcode" name="barcode" required>

      <label for="expiryDate">만료일:</label>
      <input type="text" id="expiryDate" name="expiryDate" required onfocus="(this.type='date')">

      <input type="checkbox" id="isGiftCertificate" name="isGiftCertificate" onchange="toggleBalanceInput()">
      <label for="isGiftCertificate" style="display:inline;">금액권(상품권)인가요?</label>

      <div id="initialBalanceGroup" style="display:none;">
        <label for="initialBalance">초기 금액:</label>
        <input type="number" id="initialBalance" name="initialBalance" min="0" step="0.01">
      </div>

      <label for="couponImageFile">쿠폰 이미지 (선택 사항):</label>
      <input type="file" id="couponImageFile" name="couponImageFile" accept="image/*" onchange="previewCouponImage(event)">
      <img id="couponImagePreview" src="#" alt="쿠폰 이미지 미리보기" style="max-width: 200px; max-height: 200px; margin-top: 10px; display: none;">

      <button onclick="saveCouponForm()">쿠폰 저장</button>
    </div>
  </div>

  <!-- 최신 5개 쿠폰 목록 -->
  <div class="container">
    <h2>최신 쿠폰</h2>
    <div id="latestCouponsList">
      <!-- 최신 쿠폰이 여기에 로드됩니다 -->
    </div>
    <button onclick="loadLatestCoupons()">최신 목록 새로고침</button>
  </div>

  <!-- 전체 쿠폰 목록 -->
  <div class="container">
    <h2>전체 쿠폰</h2>
    <div class="filters">
      <label for="filterStartDate">조회 시작일 (입력일 기준):</label>
      <input type="text" id="filterStartDate" onfocus="(this.type='date')">
      <label for="filterEndDate">조회 종료일 (입력일 기준):</label>
      <input type="text" id="filterEndDate" onfocus="(this.type='date')">
      <button onclick="loadAllCoupons()">필터 적용 / 목록 새로고침</button>
    </div>
    <div class="table-responsive-wrapper">
      <table id="allCouponsTable">
        <thead>
          <tr>
            <th>바코드</th>
            <th>입력일</th>
            <th>만료일</th>
            <th>유형</th>
            <th>최초 금액</th>
            <th>잔액</th>
            <th>이미지 링크</th>
            <th>사용 완료</th>
            <th>만료 상태</th>
            <th>작업</th>
          </tr>
        </thead>
        <tbody>
          <!-- 모든 쿠폰이 여기에 로드됩니다 -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- 금액권 사용 기록 모달 -->
  <div id="usageModal" style="display:none; position:fixed; top:20%; left:50%; transform:translate(-50%, -20%); background:white; padding:20px; border:1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); z-index:1000;">
    <h3>금액권 사용 기록</h3>
    <div class="usage-form">
      <input type="hidden" id="usageBarcode">
      <label for="amountUsed">사용할 금액:</label>
      <input type="number" id="amountUsed" name="amountUsed" min="0.01" step="0.01" required>
      <button onclick="submitUsageForm()">사용 기록</button>
      <button onclick="closeUsageModal()">취소</button>
    </div>
  </div>

  <!-- 일반 쿠폰 사용 처리 모달 -->
  <div id="generalCouponUsageModal" style="display:none; position:fixed; top:20%; left:50%; transform:translate(-50%, -20%); background:white; padding:20px; border:1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); z-index:1000;">
    <h3>일반 쿠폰 사용 처리</h3>
    <p id="generalCouponConfirmText"></p>
    <input type="hidden" id="generalCouponBarcodeToMark">
    <button onclick="submitMarkAsUsed()">사용 완료 처리</button>
    <button onclick="closeGeneralCouponUsageModal()">취소</button>
  </div>

<script>
  function showLoading(isLoading) {
    document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
  }

  function showMessage(message, isSuccess) {
    var msgDiv = document.getElementById('statusMessage');
    msgDiv.textContent = message;
    msgDiv.className = 'message ' + (isSuccess ? 'success' : 'error');
    msgDiv.style.display = 'block';
    setTimeout(() => { msgDiv.style.display = 'none'; }, 5000);
  }

  function toggleBalanceInput() {
    document.getElementById('initialBalanceGroup').style.display =
      document.getElementById('isGiftCertificate').checked ? 'block' : 'none';
  }

  function formatDate(dateObj) {
    if (!dateObj) return '';
    if (typeof dateObj === 'string') {
        const d = new Date(dateObj);
        if (!isNaN(d.getTime())) {
             return d.toISOString().split('T')[0];
        }
        return dateObj;
    }
    if (typeof dateObj === 'object' && dateObj.getTime) {
       return dateObj.toISOString().split('T')[0];
    }
    const d = new Date(dateObj);
    return d.toISOString().split('T')[0];
  }

  function previewCouponImage(event) {
    var reader = new FileReader();
    var imagePreview = document.getElementById('couponImagePreview');
    reader.onload = function(){
      imagePreview.src = reader.result;
      imagePreview.style.display = 'block';
    };
    if (event.target.files[0]) {
      reader.readAsDataURL(event.target.files[0]);
    } else {
      imagePreview.src = '#';
      imagePreview.style.display = 'none';
    }
  }

  function saveCouponForm() {
    showLoading(true);
    var barcode = document.getElementById('barcode').value;
    var expiryDateInput = document.getElementById('expiryDate').value;
    var isGift = document.getElementById('isGiftCertificate').checked;
    var balance = document.getElementById('initialBalance').value;
    var imageFile = document.getElementById('couponImageFile').files[0];

    var couponData = {
      barcode: barcode,
      expiryDate: expiryDateInput,
      isGiftCertificate: isGift,
      initialBalance: isGift ? parseFloat(balance) : null
    };

    if (!couponData.barcode || !couponData.expiryDate) {
      showMessage("바코드와 만료일은 필수 항목입니다.", false);
      showLoading(false);
      return;
    }
    if (couponData.isGiftCertificate && (couponData.initialBalance === null || isNaN(couponData.initialBalance) || couponData.initialBalance < 0)) {
        showMessage("금액권의 초기 금액은 0 이상의 숫자여야 합니다.", false);
        showLoading(false);
        return;
    }

    if (imageFile) {
      var reader = new FileReader();
      reader.onload = function(e) {
        var base64ImageData = e.target.result;
        var mimeType = base64ImageData.substring(base64ImageData.indexOf(':') + 1, base64ImageData.indexOf(';'));
        var fileExtension = mimeType.split('/')[1] || 'png';
        var fileName = "coupon_" + couponData.barcode + "_" + new Date().getTime() + "." + fileExtension;

        showMessage("이미지 업로드 중...", true);

        google.script.run
          .withSuccessHandler(function(uploadResponseString) {
            try {
              var uploadResponse = JSON.parse(uploadResponseString);
              if (uploadResponse.success) {
                couponData.imageFileId = uploadResponse.fileId;
                couponData.imageWebViewLink = uploadResponse.webViewLink;
                saveCouponDataToSheet(couponData);
              } else {
                showLoading(false);
                showMessage("이미지 업로드 실패: " + uploadResponse.message, false);
              }
            } catch (parseError) {
              showLoading(false);
              console.error("saveCouponForm (image upload) JSON.parse error:", parseError, "Original response:", uploadResponseString);
              showMessage("이미지 업로드 응답 처리 중 오류: " + parseError.message, false);
            }
          })
          .withFailureHandler(function(error) {
            showLoading(false);
            showMessage("이미지 업로드 중 서버 오류: " + error.message, false);
          })
          .uploadImageToDrive(base64ImageData, fileName, mimeType);
      };
      reader.onerror = function(error) {
         showLoading(false);
         showMessage("이미지 파일을 읽는 중 오류가 발생했습니다: " + error.toString(), false);
      };
      reader.readAsDataURL(imageFile);
    } else {
      saveCouponDataToSheet(couponData);
    }
  }

  function saveCouponDataToSheet(dataToSave) {
    google.script.run
      .withSuccessHandler(function(saveResponseString) {
        showLoading(false);
        try {
          var saveResponse = JSON.parse(saveResponseString);
          showMessage(saveResponse.message, saveResponse.success);
          if (saveResponse.success) {
            document.getElementById('barcode').value = '';
            document.getElementById('expiryDate').value = '';
            document.getElementById('isGiftCertificate').checked = false;
            document.getElementById('initialBalance').value = '';
            document.getElementById('couponImageFile').value = '';
            document.getElementById('couponImagePreview').style.display = 'none';
            document.getElementById('couponImagePreview').src = '#';
            toggleBalanceInput();
            loadLatestCoupons();
            loadAllCoupons();
          }
        } catch (parseError) {
          console.error("saveCouponForm (save coupon) JSON.parse error:", parseError, "Original response:", saveResponseString);
          showMessage("쿠폰 저장 응답 처리 중 오류: " + parseError.message, false);
        }
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showMessage("쿠폰 저장 중 서버 오류: " + error.message, false);
      })
      .saveCoupon(dataToSave);
  }

  function loadLatestCoupons() {
    showLoading(true);
    google.script.run
      .withSuccessHandler(function(jsonStringResponse) {
        showLoading(false);
        var listDiv = document.getElementById('latestCouponsList');
        listDiv.innerHTML = '';
        try {
          if (typeof jsonStringResponse !== 'string') {
            console.error("loadLatestCoupons 오류: JSON 문자열이 필요하지만 다음을 받음:", jsonStringResponse);
            listDiv.textContent = "오류: 서버로부터 잘못된 형식의 데이터가 수신되었습니다.";
            return;
          }
          var coupons = JSON.parse(jsonStringResponse);

          if (Array.isArray(coupons) && coupons.length > 0) {
            var ul = document.createElement('ul');
            coupons.forEach(function(coupon) {
              var li = document.createElement('li');
              var expiry = new Date(coupon.expiryDate);
              var today = new Date();
              today.setHours(0,0,0,0);

              var text = coupon.barcode + " (만료일: " + formatDate(expiry) + ")";
              if (coupon.isGiftCertificate) {
                text += " - 잔액: " + (coupon.balance !== null ? parseFloat(coupon.balance).toFixed(2) : 'N/A');
              }
              if (coupon.imageWebViewLink) {
                 text += ' (<a href="' + coupon.imageWebViewLink + '" target="_blank">이미지 보기</a>)';
              }
              li.innerHTML = text;

              if (expiry < today) {
                li.classList.add('expired');
              } else if ((expiry - today) / (1000 * 60 * 60 * 24) <= 7) {
                li.classList.add('nearing-expiry');
              }
              // Add class if fully used
              if (coupon.expiryStatus === '사용완료' || coupon.expiryStatus === '잔액없음') {
                li.classList.add('coupon-fully-used');
              }
              ul.appendChild(li);
            });
            listDiv.appendChild(ul);
          } else {
            listDiv.textContent = "최근 쿠폰이 없습니다.";
          }
        } catch (e) {
          console.error("loadLatestCoupons JSON.parse 오류:", e, "Original response:", jsonStringResponse);
          listDiv.textContent = "쿠폰 데이터 처리 중 오류가 발생했습니다.";
          showMessage("최신 쿠폰 파싱 중 오류: " + e.message, false);
        }
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showMessage("최신 쿠폰 로딩 중 오류: " + error.message, false);
      })
      .getLatestCoupons();
  }

  function loadAllCoupons() {
    showLoading(true);
    var filterStartDate = document.getElementById('filterStartDate').value;
    var filterEndDate = document.getElementById('filterEndDate').value;

    google.script.run
      .withSuccessHandler(function(jsonStringResponse) {
        showLoading(false);
        var tableBody = document.getElementById('allCouponsTable').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';
        try {
          if (typeof jsonStringResponse !== 'string') {
            console.error("loadAllCoupons 오류: JSON 문자열이 필요하지만 다음을 받음:", jsonStringResponse);
            var row = tableBody.insertRow();
            var cell = row.insertCell();
            cell.colSpan = 10; // Adjusted colspan
            cell.textContent = "오류: 서버로부터 잘못된 형식의 데이터가 수신되었습니다.";
            cell.style.textAlign = "center";
            return;
          }
          var allCoupons = JSON.parse(jsonStringResponse);

          if (!Array.isArray(allCoupons)) {
              console.error("loadAllCoupons 오류: 파싱된 데이터가 배열이 아님:", allCoupons);
              allCoupons = [];
          }

          var filteredCoupons = allCoupons.filter(function(coupon) {
            if (!coupon || typeof coupon !== 'object') return false;
            var entry = coupon.entryDate ? new Date(coupon.entryDate) : null;
            if (!entry) return false;

            if (filterStartDate && entry < new Date(filterStartDate)) {
                return false;
            }
            if (filterEndDate) {
                let endDate = new Date(filterEndDate);
                endDate.setHours(23,59,59,999);
                if (entry > endDate) return false;
            }
            return true;
          });

          if (filteredCoupons.length > 0) {
            filteredCoupons.forEach(function(coupon) {
              if (!coupon || typeof coupon !== 'object') return;
              var row = tableBody.insertRow();

              row.insertCell().textContent = coupon.barcode;
              row.insertCell().textContent = formatDate(new Date(coupon.entryDate));

              var expiryCell = row.insertCell();
              var expiryDate = new Date(coupon.expiryDate);
              expiryCell.textContent = formatDate(expiryDate);

              var today = new Date();
              today.setHours(0,0,0,0);

              if (expiryDate < today && coupon.expiryStatus === '사용가능') { // 만료되었지만 아직 '사용가능' 상태인 경우
                row.classList.add('expired');
              } else if (!row.classList.contains('expired') && (expiryDate - today) / (1000 * 60 * 60 * 24) <= 7 && coupon.expiryStatus === '사용가능') {
                row.classList.add('nearing-expiry');
              }

              if (coupon.expiryStatus === '사용완료' || coupon.expiryStatus === '잔액없음') {
                row.classList.add('coupon-fully-used');
              }

              row.insertCell().textContent = coupon.isGiftCertificate ? '금액권' : '일반 쿠폰';
              row.insertCell().textContent = coupon.isGiftCertificate && coupon.originalAmount !== null ? parseFloat(coupon.originalAmount).toFixed(2) : 'N/A';
              row.insertCell().textContent = coupon.isGiftCertificate && coupon.balance !== null ? parseFloat(coupon.balance).toFixed(2) : 'N/A';

              var imageLinkCell = row.insertCell();
              if (coupon.imageWebViewLink) {
                var link = document.createElement('a');
                link.href = coupon.imageWebViewLink;
                link.textContent = "이미지 보기";
                link.target = "_blank";
                imageLinkCell.appendChild(link);
              } else {
                imageLinkCell.textContent = "N/A";
              }

              row.insertCell().textContent = coupon.isUsed ? '예' : '아니오'; // 사용 완료 여부
              row.insertCell().textContent = coupon.expiryStatus; // 만료 상태

              var actionsCell = row.insertCell();
              actionsCell.innerHTML = ''; // Clear previous buttons/text
              if (coupon.expiryStatus === '사용가능') {
                if (coupon.isGiftCertificate) {
                  var useButton = document.createElement('button');
                  useButton.textContent = '사용 기록';
                  useButton.onclick = function() { openUsageModal(coupon.barcode, coupon.balance); };
                  actionsCell.appendChild(useButton);
                } else {
                  var markUsedButton = document.createElement('button');
                  markUsedButton.textContent = '사용 처리';
                  markUsedButton.onclick = function() { openMarkAsUsedModal(coupon.barcode); };
                  actionsCell.appendChild(markUsedButton);
                }
              } else if (coupon.expiryStatus === '잔액없음') {
                actionsCell.textContent = "잔액 없음";
              } else if (coupon.expiryStatus === '사용완료') {
                actionsCell.textContent = "사용 완료됨";
              } else {
                 actionsCell.textContent = coupon.expiryStatus; // "만료됨" 등 기타 상태
              }
            });
          } else {
            var row = tableBody.insertRow();
            var cell = row.insertCell();
            cell.colSpan = 10; // Adjusted colspan
            cell.textContent = "쿠폰이 없거나 필터 조건에 맞는 쿠폰이 없습니다.";
            cell.style.textAlign = "center";
          }
        } catch (e) {
          console.error("loadAllCoupons JSON.parse 오류:", e, "Original response:", jsonStringResponse);
          var row = tableBody.insertRow();
          var cell = row.insertCell();
          cell.colSpan = 10; // Adjusted colspan
          cell.textContent = "쿠폰 목록 처리 중 오류가 발생했습니다.";
          cell.style.textAlign = "center";
          showMessage("쿠폰 목록 파싱 중 오류: " + e.message, false);
        }
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showMessage("전체 쿠폰 로딩 중 오류: " + error.message, false);
      })
      .getCoupons();
  }

  function openMarkAsUsedModal(barcode) {
    document.getElementById('generalCouponBarcodeToMark').value = barcode;
    document.getElementById('generalCouponConfirmText').textContent = "'" + barcode + "' 쿠폰을 사용 완료로 처리하시겠습니까?";
    document.getElementById('generalCouponUsageModal').style.display = 'block';
  }

  function closeGeneralCouponUsageModal() {
    document.getElementById('generalCouponUsageModal').style.display = 'none';
  }

  function submitMarkAsUsed() {
    var barcode = document.getElementById('generalCouponBarcodeToMark').value;
    if (!barcode) {
      showMessage("오류: 처리할 쿠폰 바코드가 없습니다.", false);
      return;
    }
    showLoading(true);
    google.script.run
      .withSuccessHandler(function(responseString) {
        showLoading(false);
        try {
          var response = JSON.parse(responseString);
          showMessage(response.message, response.success);
          if (response.success) {
            closeGeneralCouponUsageModal();
            loadAllCoupons();
            loadLatestCoupons();
          }
        } catch (e) {
          console.error("submitMarkAsUsed JSON.parse error:", e, "Original response:", responseString);
          showMessage("서버 응답 처리 오류: " + e.message, false);
        }
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showMessage("쿠폰 사용 처리 중 서버 오류: " + error.message, false);
      })
      .markCouponAsUsed(barcode);
  }

  function openUsageModal(barcode, currentBalance) {
    document.getElementById('usageBarcode').value = barcode;
    document.getElementById('amountUsed').value = '';
    document.getElementById('amountUsed').max = currentBalance;
    document.getElementById('usageModal').style.display = 'block';
  }

  function closeUsageModal() {
    document.getElementById('usageModal').style.display = 'none';
  }

  function submitUsageForm() {
    showLoading(true);
    var barcode = document.getElementById('usageBarcode').value;
    var amountUsed = parseFloat(document.getElementById('amountUsed').value);

    if (isNaN(amountUsed) || amountUsed <= 0) {
        showMessage("올바른 사용 금액(0보다 큰 값)을 입력해주세요.", false);
        showLoading(false);
        return;
    }

    google.script.run
      .withSuccessHandler(function(jsonStringResponse) {
        showLoading(false);
        try {
          if (typeof jsonStringResponse !== 'string') {
            console.error("submitUsageForm 오류: JSON 문자열이 필요하지만 다음을 받음:", jsonStringResponse);
            showMessage("오류: 서버로부터 잘못된 응답입니다.", false);
            return;
          }
          var response = JSON.parse(jsonStringResponse);

          if (response.success) {
            showMessage(response.message, true);
            closeUsageModal();
            loadAllCoupons();
            loadLatestCoupons();
          } else {
            showMessage(response.message, false);
          }
        } catch (e) {
          console.error("submitUsageForm JSON.parse 오류:", e, "Original response:", jsonStringResponse);
          showMessage("서버 응답 처리 중 오류: " + e.message, false);
        }
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showMessage("사용내역 기록 중 클라이언트 오류: " + error.message, false);
      })
      .logGiftCertificateUsage(barcode, amountUsed);
  }

  window.onload = function() {
    document.getElementById('expiryDate').placeholder = 'YYYY-MM-DD (만료일)';
    document.getElementById('filterStartDate').placeholder = 'YYYY-MM-DD (조회 시작일)';
    document.getElementById('filterEndDate').placeholder = 'YYYY-MM-DD (조회 종료일)';

    var today = new Date();

    var startDateInput = document.getElementById('filterStartDate');
    var oneYearAgo = new Date(today);
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    startDateInput.value = formatDate(oneYearAgo);

    var endDateInput = document.getElementById('filterEndDate');
    var tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);
    endDateInput.value = formatDate(tomorrow);

    loadLatestCoupons();
    loadAllCoupons();
    toggleBalanceInput();
  };
</script>
</body>
</html>
