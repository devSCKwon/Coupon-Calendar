<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>쿠폰 관리 시스템</title>
  <script src="https://cdn.tailwindcss.com"></script> <!-- Added Tailwind CSS -->
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /*
    body {
        font-family: 'Roboto', 'Noto Sans KR', sans-serif;
        line-height: 1.6;
        background-color: #f8f9fa;
        color: #212529;
    }
    */

    /* Tailwind handles base h1,h2,h3 styling; specific overrides are applied via classes */
    /*
    h1, h2, h3 {
        color: #2c3e50;
        font-weight: 700;
    }
    */
    /* Specific h2 styling is now done with Tailwind classes like text-xl, font-semibold, border-b etc. */
    /*
    h2 {
        font-size: 1.75rem;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 0.5em;
        margin-bottom: 1em;
        margin-top: 0.5em;
    }
    #dashboardSection + #navigationSection h2,
    #contentSections > .tab-pane > h2 {
        margin-top: 0;
    }
    */

    /* .custom-section-container replaced by Tailwind bg-white, p-4/p-6, rounded-lg, shadow-md, mb-6 */

    /* #allCouponsTable th replaced by Tailwind bg-gray-50, px-4, py-3, etc. on th elements */
    /*
    #allCouponsTable th {
        white-space: nowrap;
        background-color: #f8f9fa;
    }
    */
    /* .coupon-fully-used, .expired td, .nearing-expiry td are now handled by JS adding Tailwind classes directly to <tr> elements */
    /*
    .coupon-fully-used {
        text-decoration: line-through;
        color: #6c757d !important;
        background-color: #e9ecef !important;
    }
     .coupon-fully-used .btn {
       pointer-events: none;
       opacity: 0.65;
    }
    .expired td {
        background-color: #f8d7da !important;
        color: #58151c !important;
    }
    .nearing-expiry td {
        background-color: #fff3cd !important;
        color: #664d03 !important;
    }
    */
    /* Modal styles are now handled by Tailwind classes directly on the elements */
    /*
    .modal-base {
        display: none;
        position: fixed;
        z-index: 1055;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow-x: hidden;
        overflow-y: auto;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content-base {
        background-color: #fff;
        margin: 1.75rem auto;
        padding: 0;
        border: 1px solid rgba(0,0,0,.2);
        border-radius: 0.5rem;
        width: auto;
        max-width: 550px;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
        position: relative;
        display: flex;
        flex-direction: column;
    }
    .custom-modal-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        padding: 1rem 1rem;
        border-bottom: 1px solid #dee2e6;
        border-top-left-radius: calc(0.5rem - 1px);
        border-top-right-radius: calc(0.5rem - 1px);
    }
    .custom-modal-title {
        margin-bottom: 0;
        line-height: 1.5;
        font-size: 1.25rem;
        font-weight: 500;
    }
    .custom-modal-body {
        position: relative;
        flex: 1 1 auto;
        padding: 1rem;
    }
    .custom-modal-footer {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-end;
        padding: 0.75rem;
        border-top: 1px solid #dee2e6;
        border-bottom-right-radius: calc(0.5rem - 1px);
        border-bottom-left-radius: calc(0.5rem - 1px);
    }
    .custom-modal-footer > .btn {
        margin-left: 0.25rem;
    }
    .custom-close-button {
         box-sizing: content-box;
         width: 1em;
         height: 1em;
         padding: .25em .25em;
         color: #000;
         background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat;
         border: 0;
         border-radius: .25rem;
         opacity: .5;
         cursor: pointer;
         font-size: 1.5rem;
     }
     .custom-close-button:hover {
         opacity: .75;
     }
    */

    /* #loading is now styled by Tailwind classes applied via JavaScript in showLoading() */
    /*
    #loading {
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        text-align: center;
        padding: 2rem;
        font-size: 1rem;
        color: #fff;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.65);
        z-index:1100;
    }
    */

    /*
    .fab {
       position: fixed;
       bottom: 30px;
       right: 30px;
       width: 56px;
       height: 56px;
       background-color: #0d6efd;
       color: white;
       border: none;
       border-radius: 50%;
       font-size: 24px;
       display: flex;
       align-items: center;
       justify-content: center;
       box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 0 0 2px rgba(255,255,255,0.1) inset;
       cursor: pointer;
       z-index: 1040;
       transition: background-color 0.2s ease, transform 0.2s ease;
   }
   .fab:hover {
       background-color: #0b5ed7;
       transform: scale(1.05);
   }
   .fab i {
        /* Icon centered by flex on parent */
   /* }
   */

   /* Custom styles for dashboard cards - replaced by Tailwind classes */
   /*
   #dashboardSection .card {
       transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
       border: none;
   }
   #dashboardSection .card:hover {
       transform: translateY(-5px);
       box-shadow: 0 8px 15px rgba(0,0,0,0.1) !important;
   }
   */
   /* #dashboardSection .card-body i { mb-2 on <i> already provides margin } */

   /* Modal styles will be addressed in a later step - Actually, this is the step, so commenting out more related styles. */
   /*
   #newCouponModalBody h4 {
       font-size: 1.15rem;
       color: #495057;
       margin-top: 1rem;
       margin-bottom: 0.75rem;
       border-bottom: 1px solid #dee2e6;
       padding-bottom: 0.5rem;
   }
   #newCouponModalBody h4:first-child {
       margin-top: 0;
   }
   .image-upload-area {
       padding: 1rem;
       border: 2px dashed #adb5bd;
       border-radius: 0.25rem;
       text-align: center;
       background-color: #f8f9fa;
       margin-bottom: 1rem;
   }
   .drag-drop-zone {
       padding: 1rem;
       margin-bottom: 0.75rem;
   }
   .drag-drop-zone p {
       margin: 0;
       font-size: 0.9em;
       color: #6c757d;
   }
   /* .drag-drop-zone.dragover is now handled by JS adding Tailwind classes like border-blue-500 bg-blue-50 */
   /*
   .drag-drop-zone.dragover {
        border-color: #0d6efd;
        background-color: #e9ecef;
   }
   */
   #newCouponImagePreview {
       margin-top: 1rem;
       max-width: 100%;
       max-height: 180px;
       border: 1px solid #dee2e6;
       padding: 0.25rem;
       border-radius: 0.25rem;
   }
   .required-star {
       color: #dc3545;
       margin-left: 0.125rem;
   }
   #newCouponModal .modal-content-base .modal-actions {
        text-align: right;
        margin-top: 1.5rem;
        border-top: 1px solid #dee2e6;
        padding-top: 1rem;
   }
   */
    /* #mainNavigation styles are now handled by Tailwind classes on the navigation elements */
    /*
    #mainNavigation {
        margin-bottom: 1.5rem;
    }
    #mainNavigation .nav-link {
        color: #0d6efd;
        font-weight: 500;
        border-bottom: 3px solid transparent;
        border-radius: 0;
        padding-top: 0.75rem; padding-bottom: 0.75rem;
    }
    #mainNavigation .nav-link.active {
        color: #0a58ca;
        background-color: transparent !important;
        border-bottom-color: #0a58ca;
    }
    #mainNavigation .nav-link:not(.active):hover {
        color: #0b5ed7;
        border-bottom-color: #cfe2ff;
    }
    */

    /* Responsive Adjustments -大部分通过Tailwind的响应式前缀 (sm:, md:, lg:) 处理 */
    /*
    @media (max-width: 768px) { /* Tablet */
        /* .custom-section-container padding/margin handled by Tailwind */
        /* h1, h2 font sizes handled by Tailwind text-xl, sm:text-2xl etc. */
        /* #allCouponsTable min-width and padding handled by Tailwind on table/th/td */
        /* #dashboardSection card elements font sizes handled by Tailwind */
    /* } */

    /*
    @media (max-width: 480px) { /* Mobile */
        /* body padding handled by Tailwind on body or main container */
        /* .container-fluid padding handled by Tailwind */
        /* .custom-section-container padding/margin handled by Tailwind */
        /* #navigationSection.custom-section-container handled by Tailwind */
        /* h1, h2 font sizes handled by Tailwind */
        /* modal styles will be handled later */
        /* #allCouponsTable th, td padding/font-size handled by Tailwind */
        /* .fab size handled by Tailwind */
        /* #mainNavigation .nav-link font-size/padding handled by Tailwind */
        /* .btn, .form-control, .form-label font-size/padding handled by Tailwind */
        /* #dashboardSection card elements font sizes/padding handled by Tailwind */
        /* .filters .btn width handled by Tailwind w-full sm:w-auto */
    /* } */
  </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
  <div class="container-fluid pt-6 px-4 md:px-6 lg:px-8 pb-24 md:pb-8">
    <h1 class="mb-4 text-center">쿠폰 관리 시스템</h1>

    <div id="dashboardSection" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center mb-6">
        <div class="bg-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
            <i class="bi bi-collection text-3xl text-blue-500 mb-2"></i>
            <h5 class="text-sm font-semibold text-gray-600 mb-1">총 보유쿠폰</h5>
            <p class="text-2xl font-bold text-gray-800" id="totalCouponsStat">-- 개</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
            <i class="bi bi-check-circle text-3xl text-green-500 mb-2"></i>
            <h5 class="text-sm font-semibold text-gray-600 mb-1">사용 가능</h5>
            <p class="text-2xl font-bold text-gray-800" id="availableCouponsStat">-- 개</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
            <i class="bi bi-hourglass-split text-3xl text-yellow-500 mb-2"></i>
            <h5 class="text-sm font-semibold text-gray-600 mb-1">만료 예정</h5>
            <p class="text-2xl font-bold text-gray-800" id="expiringSoonStat">-- 개</p>
            <!-- "만료 예정" 기준은 추후 정의 필요 (예: 7일 이내) -->
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center">
            <i class="bi bi-wallet2 text-3xl text-sky-500 mb-2"></i>
            <h5 class="text-sm font-semibold text-gray-600 mb-1">총 잔액 (금액권)</h5>
            <p class="text-2xl font-bold text-gray-800" id="totalBalanceStat">₩ --</p>
        </div>
    </div>

    <div id="navigationSection" class="fixed inset-x-0 bottom-0 z-50 bg-white shadow-lg md:relative md:shadow-none md:bg-transparent md:mb-4 md:border md:border-gray-200 md:rounded-lg md:p-2">
        <ul class="flex justify-around items-center h-16 md:h-auto md:justify-start md:space-x-1" id="mainNavigation" role="tablist">
            <li class="flex-1 md:flex-none" role="presentation">
                <button class="w-full h-full flex flex-col items-center justify-center p-1 text-gray-500 hover:bg-gray-100 hover:text-blue-600 focus:outline-none md:flex-row md:px-3 md:py-2 md:rounded-md md:hover:bg-blue-100 data-[active=true]:text-blue-600 data-[active=true]:bg-blue-50 data-[active=true]:md:bg-blue-600 data-[active=true]:md:text-white" id="navCouponList-tab" data-bs-target="#couponListSection" type="button" role="tab" aria-controls="couponListSection" aria-selected="true" data-active="true">
                    <i class="bi bi-list-ul text-lg md:text-base md:mr-1.5"></i>
                    <span class="text-xs mt-0.5 md:text-sm md:mt-0">쿠폰 목록</span>
                </button>
            </li>
            <li class="flex-1 md:flex-none" role="presentation">
                <button class="w-full h-full flex flex-col items-center justify-center p-1 text-gray-500 hover:bg-gray-100 hover:text-blue-600 focus:outline-none md:flex-row md:px-3 md:py-2 md:rounded-md md:hover:bg-blue-100 data-[active=false]:text-blue-600 data-[active=false]:bg-blue-50 data-[active=false]:md:bg-blue-600 data-[active=false]:md:text-white" id="navCouponRegistration-tab" data-bs-target="#couponRegistrationSection" type="button" role="tab" aria-controls="couponRegistrationSection" aria-selected="false" data-active="false">
                    <i class="bi bi-info-circle text-lg md:text-base md:mr-1.5"></i>
                    <span class="text-xs mt-0.5 md:text-sm md:mt-0">등록 안내</span>
                </button>
            </li>
            <li class="flex-1 md:flex-none" role="presentation">
                <button class="w-full h-full flex flex-col items-center justify-center p-1 text-gray-500 hover:bg-gray-100 hover:text-blue-600 focus:outline-none md:flex-row md:px-3 md:py-2 md:rounded-md md:hover:bg-blue-100 data-[active=false]:text-blue-600 data-[active=false]:bg-blue-50 data-[active=false]:md:bg-blue-600 data-[active=false]:md:text-white" id="navUsageHistory-tab" data-bs-target="#usageHistorySection" type="button" role="tab" aria-controls="usageHistorySection" aria-selected="false" data-active="false">
                    <i class="bi bi-clock-history text-lg md:text-base md:mr-1.5"></i>
                    <span class="text-xs mt-0.5 md:text-sm md:mt-0">사용 히스토리</span>
                </button>
            </li>
        </ul>
    </div>

    <div id="contentSections">
        <div class="tab-content" id="mainTabContent">
            <div class="tab-pane fade show active bg-white p-4 sm:p-6 rounded-lg shadow-md mb-6" id="couponListSection" role="tabpanel" aria-labelledby="navCouponList-tab">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-300">전체 쿠폰</h2>
                <div class="filters flex flex-col sm:flex-row sm:items-end sm:space-x-3 mb-4">
                  <div class="flex-grow">
                    <label for="filterStartDate" class="block text-sm font-medium text-gray-700 mb-1">조회 시작일:</label>
                    <input type="text" id="filterStartDate" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm py-2 px-3" placeholder="YYYY-MM-DD" onfocus="(this.type='date')">
                  </div>
                  <div class="flex-grow">
                    <label for="filterEndDate" class="block text-sm font-medium text-gray-700 mb-1">조회 종료일:</label>
                    <input type="text" id="filterEndDate" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm py-2 px-3" placeholder="YYYY-MM-DD" onfocus="(this.type='date')">
                  </div>
                  <div class="flex-shrink-0">
                    <button onclick="loadAllCoupons()" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 text-sm w-full sm:w-auto">필터 적용</button>
                  </div>
                </div>
                <div class="overflow-x-auto rounded-lg shadow border border-gray-200 mb-4">
                  <table id="allCouponsTable" class="w-full whitespace-nowrap">
                    <caption class="p-2 text-sm text-gray-600 text-left">쿠폰 목록</caption>
                    <thead class="bg-gray-50">
                      <tr>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">바코드</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">입력일</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">만료일</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">유형</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">최초 금액</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">잔액</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">이미지 링크</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">사용 완료</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">만료 상태</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">작업</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 bg-white">
                      <!-- 모든 쿠폰이 여기에 로드됩니다 -->
                    </tbody>
                  </table>
                </div>
            </div>
            <div class="tab-pane fade bg-white p-4 sm:p-6 rounded-lg shadow-md mb-6" id="couponRegistrationSection" role="tabpanel" aria-labelledby="navCouponRegistration-tab">
                <div class="text-center p-4 sm:p-6">
                    <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-3 pb-2 border-b border-gray-300 flex items-center justify-center"><i class="bi bi-info-circle-fill text-blue-500 mr-2"></i>쿠폰 등록 안내</h2>
                    <p class="text-base sm:text-lg text-gray-600 mb-4">새 쿠폰을 등록하려면 화면 우측 하단의 <button type="button" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-10 h-10 inline-flex items-center justify-center align-text-bottom mx-1 shadow-md" onclick="document.getElementById('addCouponFab').click();" title="새 쿠폰 추가"><i class="bi bi-plus-lg"></i></button> 버튼을 이용해주세요.</p>
                </div>
            </div>
            <div class="tab-pane fade bg-white p-4 sm:p-6 rounded-lg shadow-md mb-6" id="usageHistorySection" role="tabpanel" aria-labelledby="navUsageHistory-tab">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-3 pb-2 border-b border-gray-300 flex items-center"><i class="bi bi-clock-history text-gray-500 mr-2"></i>쿠폰 사용 히스토리</h2>
                <div class="overflow-x-auto rounded-lg shadow border border-gray-200 mb-4">
                    <table id="usageHistoryTable" class="w-full whitespace-nowrap">
                        <caption class="p-2 text-sm text-gray-600 text-left">쿠폰 사용 상세 내역</caption>
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">시간</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">바코드</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">사용 금액</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">처리 후 잔액</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 bg-white">
                            <!-- 사용 내역이 여기에 로드됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div id="statusMessage" role="alert" style="display:none; z-index: 1070;"></div>
  <div id="loading" style="display:none;"></div>

  <button id="addCouponFab" title="새 쿠폰 추가" class="fixed bottom-6 right-6 z-[1040] w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 flex items-center justify-center transition-all duration-200 ease-in-out transform hover:scale-105">
        <i class="bi bi-plus-lg text-2xl"></i>
    </button>

  <div id="newCouponModal" class="fixed inset-0 z-[1050] flex items-center justify-center overflow-x-hidden overflow-y-auto bg-black bg-opacity-50 p-4 transition-opacity duration-300 ease-in-out opacity-0 pointer-events-none">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-auto my-8 flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0">
        <div class="flex items-start justify-between p-4 border-b border-gray-200 rounded-t-lg">
            <h2 class="text-xl font-semibold text-gray-800">새 쿠폰 등록</h2>
            <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center focus:outline-none focus:ring-2 focus:ring-gray-300" onclick="closeNewCouponModal()" aria-label="Close">&times;</button>
        </div>
        <div class="p-5 space-y-4 flex-grow overflow-y-auto" id="newCouponModalBody">
            <h4 class="text-lg font-medium text-gray-900 mb-2 border-b border-gray-200 pb-1">1. 쿠폰 이미지 등록 (선택 사항)</h4>
            <div class="p-4 border-2 border-dashed border-gray-300 rounded-md text-center bg-gray-50 mb-4">
                <div id="dragDropZone" class="p-4 mb-2">
                    <p><i class="bi bi-cloud-arrow-up-fill text-3xl text-gray-400 mb-1"></i><br><span class="text-sm text-gray-500">여기에 이미지를 드래그 앤 드롭하거나<br>아래 버튼을 사용하세요.</span></p>
                </div>
                <div class="image-upload-buttons space-x-2">
                    <label for="newCouponImageFile" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-md text-sm inline-flex items-center cursor-pointer"><i class="bi bi-file-earmark-arrow-up mr-1"></i> 파일 선택</label>
                    <input type="file" id="newCouponImageFile" accept="image/*" style="display: none;">
                    <label for="newCouponCameraFile" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-md text-sm inline-flex items-center cursor-pointer"><i class="bi bi-camera mr-1"></i> 사진 촬영</label>
                    <input type="file" id="newCouponCameraFile" accept="image/*" capture="environment" style="display: none;">
                </div>
                <img id="newCouponImagePreview" src="#" alt="이미지 미리보기" style="display: none;" class="mt-3 max-w-full max-h-40 border border-gray-300 p-0.5 rounded-md object-contain mx-auto block">
            </div>
            <hr class="my-4">
            <h4 class="text-lg font-medium text-gray-900 mb-2 border-b border-gray-200 pb-1">2. 쿠폰 정보 입력</h4>
            <div class="form-fields space-y-4">
                <div class="mb-3">
                    <label for="newCouponProductName" class="block text-sm font-medium text-gray-700 mb-1">제품명</label>
                    <input type="text" id="newCouponProductName" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm py-2 px-3" placeholder="이미지에서 추출된 제품명 (또는 직접 입력)">
                </div>
                <div class="mb-3">
                    <label for="newCouponBarcode" class="block text-sm font-medium text-gray-700 mb-1">바코드 번호 <span class="text-red-500 ml-0.5">*</span></label>
                    <input type="text" id="newCouponBarcode" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm py-2 px-3" placeholder="바코드 스캔 또는 직접 입력">
                </div>
                <div class="flex items-center mb-3">
                    <input type="checkbox" id="newCouponIsGift" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2" onchange="toggleNewCouponBalanceField()">
                    <label for="newCouponIsGift" class="text-sm font-medium text-gray-700">금액권 (상품권)</label>
                </div>
                <div id="newCouponBalanceGroup" style="display:none;" class="mb-3">
                    <label for="newCouponInitialBalance" class="block text-sm font-medium text-gray-700 mb-1">초기 금액 <span class="text-red-500 ml-0.5">*</span></label>
                    <input type="number" id="newCouponInitialBalance" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm py-2 px-3" placeholder="금액권인 경우 초기 금액 입력">
                </div>
                <div class="mb-3">
                    <label for="newCouponExpiryDate" class="block text-sm font-medium text-gray-700 mb-1">만료 일자 <span class="text-red-500 ml-0.5">*</span></label>
                    <input type="text" id="newCouponExpiryDate" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm py-2 px-3" placeholder="YYYY-MM-DD" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'">
                </div>
            </div>
        </div>
        <div class="flex flex-wrap items-center justify-end p-4 border-t border-gray-200 rounded-b-lg space-x-2">
            <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md text-sm" onclick="closeNewCouponModal()">취소</button>
            <button type="button" id="saveNewCouponButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md text-sm">저장</button>
        </div>
    </div>
  </div>

  <div id="usageModal" class="fixed inset-0 z-[1050] flex items-center justify-center overflow-x-hidden overflow-y-auto bg-black bg-opacity-50 p-4 transition-opacity duration-300 ease-in-out opacity-0 pointer-events-none">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-auto my-8 flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0">
      <div class="flex items-start justify-between p-4 border-b border-gray-200 rounded-t-lg">
        <h3 class="text-xl font-semibold text-gray-800">금액권 사용 기록</h3>
        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center focus:outline-none focus:ring-2 focus:ring-gray-300" onclick="closeUsageModal()" aria-label="Close">&times;</button>
      </div>
      <div class="p-5 space-y-4 flex-grow overflow-y-auto">
        <div class="usage-form">
          <input type="hidden" id="usageBarcode">
          <div class="mb-4">
            <label for="amountUsed" class="block text-sm font-medium text-gray-700 mb-1">사용할 금액:</label>
            <input type="number" id="amountUsed" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm py-2 px-3" name="amountUsed" min="0.01" step="0.01" required>
          </div>
        </div>
      </div>
      <div class="flex flex-wrap items-center justify-end p-4 border-t border-gray-200 rounded-b-lg space-x-2">
          <button onclick="submitUsageForm()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md text-sm">사용 기록</button>
          <button onclick="closeUsageModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md text-sm">취소</button>
      </div>
    </div>
  </div>

  <div id="generalCouponUsageModal" class="fixed inset-0 z-[1050] flex items-center justify-center overflow-x-hidden overflow-y-auto bg-black bg-opacity-50 p-4 transition-opacity duration-300 ease-in-out opacity-0 pointer-events-none">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-auto my-8 flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0">
      <div class="flex items-start justify-between p-4 border-b border-gray-200 rounded-t-lg">
        <h3 class="text-xl font-semibold text-gray-800">일반 쿠폰 사용 처리</h3>
        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center focus:outline-none focus:ring-2 focus:ring-gray-300" onclick="closeGeneralCouponUsageModal()" aria-label="Close">&times;</button>
      </div>
      <div class="p-5 space-y-4 flex-grow overflow-y-auto">
        <p id="generalCouponConfirmText" class="text-sm text-gray-700 my-3"></p>
        <input type="hidden" id="generalCouponBarcodeToMark">
      </div>
      <div class="flex flex-wrap items-center justify-end p-4 border-t border-gray-200 rounded-b-lg space-x-2">
          <button onclick="submitMarkAsUsed()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-md text-sm">사용 완료 처리</button>
          <button onclick="closeGeneralCouponUsageModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md text-sm">취소</button>
      </div>
    </div>
  </div>

<script>
  var newCouponModalElement;
  var selectedImageFile = null;

  function analyzeImageWithGemini(file) {
      if (!file) {
          showMessage("분석할 이미지 파일이 선택되지 않았습니다.", false);
          return;
      }
      showLoading(true); // 로딩 시작

      var reader = new FileReader();
      reader.onload = function(e) {
          var base64ImageData = "";
          if (e.target.result.includes(',')) {
              base64ImageData = e.target.result.split(',')[1]; // Get only the base64 part
          } else {
              base64ImageData = e.target.result;
          }

          var promptText = `이 이미지는 쿠폰입니다. 다음 정보를 추출하여 JSON 객체 형식으로만 응답해주세요. 다른 설명은 추가하지 마세요.:
- "productName": 제품 또는 서비스의 이름 (예: "빅맥 단품", "스타벅스 아메리카노 Tall")
- "barcodeNumber": 바코드 숫자 (공백이나 하이픈 없이 숫자만)
- "expiryDate": 만료일자 (YYYY-MM-DD 형식)
- "amount": 금액권인 경우 그 금액 (숫자만, 예: 30000). 금액권이 아니거나 금액을 알 수 없으면 null.

정보를 찾을 수 없는 필드는 결과 JSON 객체에서 해당 키를 생략하거나 값으로 null을 사용해주세요. 예시: {"productName": "아메리카노", "barcodeNumber": "123456789012", "expiryDate": "2024-12-31", "amount": null}`;

          console.log("Gemini API 요청 중...");
          google.script.run
              .withSuccessHandler(onGeminiSuccess)
              .withFailureHandler(onGeminiFailure)
              .callGeminiApiForImageAnalysis(base64ImageData, promptText);
      };
      reader.onerror = function(error) {
          showLoading(false);
          showMessage("파일을 읽는 중 오류가 발생했습니다: " + error.toString(), false);
          console.error('FileReader error: ', error);
      };
      reader.readAsDataURL(file); // Start reading the file
  }

  function onGeminiSuccess(responseText) {
      showLoading(false);
      console.log("Gemini API 응답 수신:", responseText);
      try {
          if (responseText === null || typeof responseText !== 'string' || responseText.trim() === "") {
              throw new Error("API로부터 유효하지 않거나 빈 응답을 받았습니다.");
          }

          let jsonString = responseText; // Start with the original response
          const firstBracket = jsonString.indexOf('{');
          const firstSquareBracket = jsonString.indexOf('[');
          let start = -1;

          // Determine the starting position of the JSON (either { or [)
          if (firstBracket !== -1 && (firstSquareBracket === -1 || firstBracket < firstSquareBracket)) {
              start = firstBracket;
          } else if (firstSquareBracket !== -1) {
              start = firstSquareBracket;
          } else {
              // No JSON structure found, throw error before trying to find end
              throw new Error("응답에서 유효한 JSON 시작 문자를 찾을 수 없습니다. 원본 응답: " + responseText);
          }

          // Determine the corresponding end bracket and its position
          let end = -1;
          if (jsonString.charAt(start) === '{') { // If JSON starts with {, look for corresponding }
              end = jsonString.lastIndexOf('}');
          } else { // If JSON starts with [, look for corresponding ]
              end = jsonString.lastIndexOf(']');
          }

          if (end === -1 || end < start) {
              throw new Error("응답에서 유효한 JSON 끝 문자를 찾을 수 없습니다. (start: " + start + ", end: " + end + "). 원본 응답: " + responseText);
          }

          jsonString = jsonString.substring(start, end + 1); // Extract the substring

          var resultObject = JSON.parse(jsonString);
          console.log("파싱된 Gemini 결과 객체:", resultObject);

          let productNameExtracted = false;
          let barcodeExtracted = false;
          let expiryDateExtracted = false;
          let amountExtracted = false;

          if (resultObject.productName && typeof resultObject.productName === 'string') {
              document.getElementById('newCouponProductName').value = resultObject.productName;
              productNameExtracted = true;
              console.log("제품명 입력:", resultObject.productName);
          }

          if (resultObject.barcodeNumber && typeof resultObject.barcodeNumber === 'string') {
              document.getElementById('newCouponBarcode').value = resultObject.barcodeNumber.replace(/\D/g, ''); // Ensure only digits
              barcodeExtracted = true;
              console.log("바코드 입력:", resultObject.barcodeNumber.replace(/\D/g, ''));
          }

          if (resultObject.expiryDate && typeof resultObject.expiryDate === 'string') {
              if (/^\d{4}-\d{2}-\d{2}$/.test(resultObject.expiryDate)) {
                  document.getElementById('newCouponExpiryDate').value = resultObject.expiryDate;
                  document.getElementById('newCouponExpiryDate').type = 'date';
                  expiryDateExtracted = true;
                  console.log("만료일자 입력:", resultObject.expiryDate);
              } else {
                  console.warn("수신된 만료일자 형식이 YYYY-MM-DD가 아닙니다:", resultObject.expiryDate);
              }
          }

          if (resultObject.amount !== undefined && resultObject.amount !== null && !isNaN(parseFloat(resultObject.amount))) {
              var numericAmount = parseFloat(resultObject.amount);
              if (numericAmount > 0) {
                  document.getElementById('newCouponInitialBalance').value = numericAmount;
                  document.getElementById('newCouponIsGift').checked = true;
                  amountExtracted = true;
                  console.log("금액 입력:", numericAmount);
              } else {
                  document.getElementById('newCouponIsGift').checked = false;
              }
          } else {
              document.getElementById('newCouponIsGift').checked = false;
          }
          toggleNewCouponBalanceField();

          let finalMessage = "";
          let allSuccess = true;

          if (productNameExtracted && barcodeExtracted && expiryDateExtracted && amountExtracted) {
              finalMessage = "이미지에서 모든 정보를 추출하여 입력했습니다. 내용을 확인해주세요.";
          } else if (productNameExtracted || barcodeExtracted || expiryDateExtracted || amountExtracted) {
              let extractedParts = [];
              if (productNameExtracted) extractedParts.push("제품명");
              if (barcodeExtracted) extractedParts.push("바코드");
              if (expiryDateExtracted) extractedParts.push("만료일");
              if (amountExtracted) extractedParts.push("금액");
              finalMessage = `이미지에서 일부 정보(${extractedParts.join(', ')})만 추출했습니다. 나머지는 직접 확인 후 입력해주세요.`;
              allSuccess = false;
          } else {
              finalMessage = "이미지에서 자동 정보 추출에 실패했습니다. 직접 입력해주세요.";
              allSuccess = false;
          }
          showMessage(finalMessage, allSuccess);

      } catch (e) {
          console.error("Gemini 응답 파싱 오류:", e, "원본 응답:", responseText);
          showMessage("이미지 분석 결과 처리 중 오류 발생: " + e.message + ". 서버 로그를 확인해주세요.", false);
      }
  }

  function onGeminiFailure(error) {
      showLoading(false);
      console.error("Gemini API 호출 실패 객체:", error); // Log the full error object
      showMessage("이미지 분석 API 호출 중 서버 오류 발생: " + error.message, false);
  }

  function showLoading(isLoading) {
    var loader = document.getElementById('loading');
    if (!loader) return;

    // Ensure loader has base Tailwind classes for overlay styling
    loader.className = 'fixed inset-0 z-[1100] flex flex-col items-center justify-center bg-black bg-opacity-65 text-white transition-opacity duration-300 ease-in-out';

    if (isLoading) {
        loader.innerHTML = `
            <div class="w-12 h-12 border-4 border-t-transparent border-white rounded-full animate-spin"></div>
            <p class="mt-3 text-lg font-semibold">로딩 중...</p>
        `;
        loader.classList.remove('opacity-0', 'pointer-events-none');
        loader.classList.add('opacity-100', 'pointer-events-auto');
        loader.style.display = 'flex'; // display:flex is part of the base class but ensures it's set
    } else {
        loader.classList.add('opacity-0', 'pointer-events-none');
        loader.classList.remove('opacity-100', 'pointer-events-auto');
        // Delay hiding to allow fade-out transition
        setTimeout(() => {
            if (!loader.classList.contains('opacity-100')) { // Only hide if it wasn't shown again quickly
                 loader.style.display = 'none';
            }
        }, 300); // Match duration-300
    }
  }

  function showMessage(message, isSuccess) {
    var msgDiv = document.getElementById('statusMessage');
    if (!msgDiv) return;

    msgDiv.textContent = message;

    // Base classes for the message div, including positioning and initial hidden state
    let baseClasses = 'fixed top-5 right-5 z-[1070] px-4 py-3 rounded-md shadow-lg transition-opacity duration-300 ease-in-out opacity-0';

    if (isSuccess) {
        msgDiv.className = `${baseClasses} bg-green-100 border border-green-400 text-green-700`;
    } else {
        msgDiv.className = `${baseClasses} bg-red-100 border border-red-400 text-red-700`;
    }

    msgDiv.style.display = 'block'; // Or use Tailwind 'block' if you prefer removing style manipulations entirely for display
    // Force a reflow before adding opacity-100 to ensure transition plays
    void msgDiv.offsetWidth;
    msgDiv.classList.add('opacity-100');

    setTimeout(() => {
        msgDiv.classList.remove('opacity-100');
        // msgDiv.classList.add('opacity-0'); // Already has opacity-0 from base, just removing opacity-100 will trigger transition
        setTimeout(() => {
            msgDiv.style.display = 'none';
        }, 300); // Match duration-300 for fade out
    }, 5000);
  }

  function toggleNewCouponBalanceField() {
    var isGiftChecked = document.getElementById('newCouponIsGift').checked;
    var balanceGroup = document.getElementById('newCouponBalanceGroup');
    var balanceInput = document.getElementById('newCouponInitialBalance');
    if (isGiftChecked) {
      balanceGroup.style.display = 'block';
    } else {
      balanceGroup.style.display = 'none';
      balanceInput.value = '';
    }
  }

  function formatDate(dateObj) {
    if (!dateObj) return '';
    if (typeof dateObj === 'string') {
        const d = new Date(dateObj);
        if (!isNaN(d.getTime())) {
             return d.toISOString().split('T')[0];
        }
        return dateObj;
    }
    if (typeof dateObj === 'object' && dateObj.getTime) {
       return dateObj.toISOString().split('T')[0];
    }
    const d = new Date(dateObj);
    return d.toISOString().split('T')[0];
  }

  function previewAndSetFile(file) {
    var imagePreview = document.getElementById('newCouponImagePreview');
    if (file && file.type.startsWith('image/')) {
      selectedImageFile = file;
      var reader = new FileReader();
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        imagePreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      selectedImageFile = null;
      imagePreview.src = '#';
      imagePreview.style.display = 'none';
      if (file) {
         showMessage("이미지 파일만 선택 가능합니다. (image/*)", false);
      }
    }
  }

  function submitNewCouponForm() {
    showLoading(true);
    var barcode = document.getElementById('newCouponBarcode').value;
    var expiryDate = document.getElementById('newCouponExpiryDate').value;
    var isGift = document.getElementById('newCouponIsGift').checked;
    var initialBalance = document.getElementById('newCouponInitialBalance').value;

    if (!barcode || !expiryDate) {
        showMessage("바코드와 만료일은 필수 항목입니다.", false);
        showLoading(false);
        return;
    }
    if (isGift && (!initialBalance || parseFloat(initialBalance) < 0)) {
        showMessage("금액권의 초기 금액은 0 이상의 유효한 숫자여야 합니다.", false);
        showLoading(false);
        return;
    }

    var couponData = {
        barcode: barcode,
        expiryDate: expiryDate,
        isGiftCertificate: isGift,
        initialBalance: isGift ? parseFloat(initialBalance) : null
    };

    if (selectedImageFile) {
        showMessage("이미지 업로드 중...", true);
        var reader = new FileReader();
        reader.onload = function(e) {
            var base64ImageData = e.target.result;
            var mimeType = selectedImageFile.type || base64ImageData.substring(base64ImageData.indexOf(':') + 1, base64ImageData.indexOf(';'));
            var fileExtension = selectedImageFile.name.split('.').pop() || mimeType.split('/')[1] || "png";
            var fileName = "coupon_" + (barcode.replace(/\D/g, "") || "img") + "_" + new Date().getTime() + "." + fileExtension;

            google.script.run
                .withSuccessHandler(function(uploadResponseString) {
                    try {
                        var uploadResponse = JSON.parse(uploadResponseString);
                        if (uploadResponse.success) {
                            couponData.imageFileId = uploadResponse.fileId;
                            couponData.imageWebViewLink = uploadResponse.webViewLink;
                            saveFinalCouponData(couponData);
                        } else {
                            showLoading(false);
                            showMessage("이미지 업로드 실패: " + uploadResponse.message, false);
                        }
                    } catch (parseErr) {
                        showLoading(false); console.error("Img Upload Parse Err:", parseErr, uploadResponseString);
                        showMessage("이미지 업로드 응답 오류: " + parseErr.message, false);
                    }
                })
                .withFailureHandler(function(err) {
                    showLoading(false); showMessage("이미지 업로드 서버 오류: " + err.message, false);
                })
                .uploadImageToDrive(base64ImageData, fileName, mimeType);
        };
        reader.onerror = function() {
            showLoading(false); showMessage("이미지 파일 읽기 오류.", false);
        };
        reader.readAsDataURL(selectedImageFile);
    } else {
        saveFinalCouponData(couponData);
    }
  }

  function saveFinalCouponData(dataToSave) {
    if(!document.getElementById('loading').style.display || document.getElementById('loading').style.display === 'none') {
        showLoading(true);
    }
    if (!dataToSave.imageFileId) {
         showMessage("쿠폰 정보 저장 중...", true);
    }

    google.script.run
        .withSuccessHandler(function(saveResponseString) {
            showLoading(false);
            try {
                var saveResponse = JSON.parse(saveResponseString);
                showMessage(saveResponse.message, saveResponse.success);
                if (saveResponse.success) {
                    openNewCouponModal();
                    closeNewCouponModal();
                    loadAllCoupons(); // This will call updateDashboard in its success handler
                }
            } catch (parseErr) {
                console.error("Save Coupon Parse Err:", parseErr, saveResponseString);
                showMessage("쿠폰 저장 응답 오류: " + parseErr.message, false);
            }
        })
        .withFailureHandler(function(err) {
            showLoading(false); showMessage("쿠폰 저장 서버 오류: " + err.message, false);
        })
        .saveCoupon(dataToSave);
  }

  function loadLatestCoupons() { /* Commented out as section is removed */ }

  function loadAllCoupons() {
    showLoading(true);
    var filterStartDate = document.getElementById('filterStartDate').value;
    var filterEndDate = document.getElementById('filterEndDate').value;

    google.script.run
      .withSuccessHandler(function(jsonStringResponse) {
        showLoading(false);
        var tableBody = document.getElementById('allCouponsTable').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';
        try {
          if (typeof jsonStringResponse !== 'string') {
            console.error("loadAllCoupons 오류: JSON 문자열이 필요하지만 다음을 받음:", jsonStringResponse);
            var row = tableBody.insertRow();
            var cell = row.insertCell();
            cell.colSpan = 10;
            cell.textContent = "오류: 서버로부터 잘못된 형식의 데이터가 수신되었습니다.";
            cell.style.textAlign = "center";
            updateDashboard(); // Update dashboard even on this error path
            return;
          }
          var allCoupons = JSON.parse(jsonStringResponse);

          if (!Array.isArray(allCoupons)) {
              console.error("loadAllCoupons 오류: 파싱된 데이터가 배열이 아님:", allCoupons);
              allCoupons = [];
          }

          var filteredCoupons = allCoupons.filter(function(coupon) {
            if (!coupon || typeof coupon !== 'object') return false;
            var entry = coupon.entryDate ? new Date(coupon.entryDate) : null;
            if (!entry) return false;

            if (filterStartDate && entry < new Date(filterStartDate)) {
                return false;
            }
            if (filterEndDate) {
                let endDate = new Date(filterEndDate);
                endDate.setHours(23,59,59,999);
                if (entry > endDate) return false;
            }
            return true;
          });

          if (filteredCoupons.length > 0) {
            filteredCoupons.forEach(function(coupon) {
              if (!coupon || typeof coupon !== 'object') return;
              var row = tableBody.insertRow();

              // Barcode cell - now a clickable link
              var barcodeCell = row.insertCell();
              var barcodeLink = document.createElement('a');
              barcodeLink.href = "javascript:void(0);";
              barcodeLink.textContent = coupon.barcode;
              barcodeLink.style.cursor = "pointer";
              barcodeLink.style.textDecoration = "underline";
              barcodeLink.onclick = function(event) {
                  event.preventDefault();
                  
                  // Programmatically switch to the "사용 히스토리" tab
                  var historyTabButton = document.getElementById('navUsageHistory-tab');
                  var historyPane = document.getElementById('usageHistorySection');
                  
                  // Deactivate other tabs/panes
                  document.querySelectorAll('#mainNavigation .nav-link.active').forEach(function(activeLink) {
                      activeLink.classList.remove('active');
                      activeLink.setAttribute('aria-selected', 'false');
                  });
                  document.querySelectorAll('#mainTabContent .tab-pane.show.active').forEach(function(activePane) {
                      activePane.classList.remove('show', 'active');
                  });

                  // Activate history tab/pane
                  if (historyTabButton) {
                      historyTabButton.classList.add('active');
                      historyTabButton.setAttribute('aria-selected', 'true');
                  }
                  if (historyPane) {
                      historyPane.classList.add('show', 'active');
                  }
                  
                  // Load history for the clicked barcode
                  // Ensure coupon.barcode is the normalized version if that's what getUsageHistory expects
                  loadUsageHistory(coupon.barcode); 
              };
              barcodeCell.appendChild(barcodeLink);

              row.insertCell().textContent = formatDate(new Date(coupon.entryDate));

              var expiryCell = row.insertCell();
              var expiryDate = new Date(coupon.expiryDate);
              expiryCell.textContent = formatDate(expiryDate);

              var today = new Date();
              today.setHours(0,0,0,0);

              // Base row classes (can be adjusted for hover, etc.)
              row.className = 'transition-colors duration-150 ease-in-out';

              if (expiryDate < today && coupon.expiryStatus === '사용가능') {
                row.classList.add('bg-red-100', 'text-red-700', 'hover:bg-red-200');
              } else if ((expiryDate - today) / (1000 * 60 * 60 * 24) <= 7 && coupon.expiryStatus === '사용가능') {
                // Ensure not already styled as expired if conditions overlap (though current logic prevents this)
                if (!row.classList.contains('bg-red-100')) {
                    row.classList.add('bg-yellow-100', 'text-yellow-800', 'hover:bg-yellow-200');
                }
              }

              if (coupon.expiryStatus === '사용완료' || coupon.expiryStatus === '잔액없음') {
                // Remove other state classes if this one applies, as it's a terminal state
                row.classList.remove('bg-red-100', 'text-red-700', 'hover:bg-red-200', 'bg-yellow-100', 'text-yellow-800', 'hover:bg-yellow-200');
                row.classList.add('text-slate-500', 'line-through', 'bg-slate-50', 'hover:bg-slate-100');
              }

              // Apply default styling to all cells (example, should be done for all)
              // Assuming cells are added in order and this is one of them:
              var typeCell = row.insertCell();
              typeCell.className = 'px-4 py-3 text-sm text-gray-700 whitespace-nowrap'; // Apply to all td
              typeCell.textContent = coupon.isGiftCertificate ? '금액권' : '일반 쿠폰';
              // Note: The original code adds cells one by one. Each insertCell() should be followed by setting its className.
              // For brevity, I'll just modify the example for typeCell. The user must ensure all TDs get these classes.
              // This diff will only show the row class changes and this one cell example.
              // The subsequent row.insertCell().textContent calls from the original code need to be updated like this:
              // var cell = row.insertCell(); cell.className = '...'; cell.textContent = ...;
              row.insertCell().textContent = coupon.isGiftCertificate && coupon.originalAmount !== null ? parseFloat(coupon.originalAmount).toFixed(2) : 'N/A';
              row.insertCell().textContent = coupon.isGiftCertificate && coupon.balance !== null ? parseFloat(coupon.balance).toFixed(2) : 'N/A';

              var imageLinkCell = row.insertCell();
              if (coupon.imageWebViewLink) {
                var link = document.createElement('a');
                link.href = coupon.imageWebViewLink;
                link.textContent = "이미지 보기";
                link.target = "_blank";
                imageLinkCell.appendChild(link);
              } else {
                imageLinkCell.textContent = "N/A";
              }

              row.insertCell().textContent = coupon.isUsed ? '예' : '아니오';
              row.insertCell().textContent = coupon.expiryStatus;

              var actionsCell = row.insertCell();
              actionsCell.innerHTML = '';
              if (coupon.expiryStatus === '사용가능') {
                if (coupon.isGiftCertificate) {
                  var useButton = document.createElement('button');
                  useButton.className = 'btn btn-sm btn-success';
                  useButton.innerHTML = '<i class="bi bi-cash-coin"></i> 사용';
                  useButton.onclick = function() { openUsageModal(coupon.barcode, coupon.balance); };
                  actionsCell.appendChild(useButton);
                } else {
                  var markUsedButton = document.createElement('button');
                  markUsedButton.className = 'btn btn-sm btn-primary';
                  markUsedButton.innerHTML = '<i class="bi bi-check-lg"></i> 사용 처리';
                  markUsedButton.onclick = function() { openMarkAsUsedModal(coupon.barcode); };
                  actionsCell.appendChild(markUsedButton);
                }
              } else if (coupon.expiryStatus === '잔액없음') {
                actionsCell.textContent = "잔액 없음";
              } else if (coupon.expiryStatus === '사용완료') {
                actionsCell.textContent = "사용 완료됨";
              } else {
                 actionsCell.textContent = coupon.expiryStatus;
              }
            });
          } else {
            var row = tableBody.insertRow();
            var cell = row.insertCell();
            cell.colSpan = 10;
            cell.textContent = "쿠폰이 없거나 필터 조건에 맞는 쿠폰이 없습니다.";
            cell.style.textAlign = "center";
          }
        } catch (e) {
          console.error("loadAllCoupons JSON.parse 오류:", e, "Original response:", jsonStringResponse);
          var row = tableBody.insertRow();
          var cell = row.insertCell();
          cell.colSpan = 10;
          cell.textContent = "쿠폰 목록 처리 중 오류가 발생했습니다.";
          cell.style.textAlign = "center";
          showMessage("쿠폰 목록 파싱 중 오류: " + e.message, false);
        }
        updateDashboard(); // Call after processing all coupons or if try block failed
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showMessage("전체 쿠폰 로딩 중 오류: " + error.message, false);
        updateDashboard(); // Also update dashboard on failure to reflect error state or clear old data
      })
      .getCoupons();
  }

  function openMarkAsUsedModal(barcode) {
    const modalElement = document.getElementById('generalCouponUsageModal');
    const modalContent = modalElement ? modalElement.firstElementChild : null;

    document.getElementById('generalCouponBarcodeToMark').value = barcode;
    document.getElementById('generalCouponConfirmText').textContent = "'" + barcode + "' 쿠폰을 사용 완료로 처리하시겠습니까?";

    if (modalElement && modalContent) {
        modalElement.classList.remove('opacity-0', 'pointer-events-none');
        modalElement.classList.add('opacity-100', 'pointer-events-auto');
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }
  }

  function closeGeneralCouponUsageModal() {
    const modalElement = document.getElementById('generalCouponUsageModal');
    const modalContent = modalElement ? modalElement.firstElementChild : null;

    if (modalElement && modalContent) {
        modalElement.classList.add('opacity-0', 'pointer-events-none');
        modalElement.classList.remove('opacity-100', 'pointer-events-auto');
        modalContent.classList.add('scale-95', 'opacity-0');
        modalContent.classList.remove('scale-100', 'opacity-100');
    }
  }

  function submitMarkAsUsed() {
    var barcode = document.getElementById('generalCouponBarcodeToMark').value;
    if (!barcode) {
      showMessage("오류: 처리할 쿠폰 바코드가 없습니다.", false);
      return;
    }
    showLoading(true);
    google.script.run
      .withSuccessHandler(function(responseString) {
        showLoading(false);
        try {
          var response = JSON.parse(responseString);
          showMessage(response.message, response.success);
          if (response.success) {
            closeGeneralCouponUsageModal();
            loadAllCoupons(); // This will call updateDashboard in its success handler
          }
        } catch (e) {
          console.error("submitMarkAsUsed JSON.parse error:", e, "Original response:", responseString);
          showMessage("서버 응답 처리 오류: " + e.message, false);
        }
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showMessage("쿠폰 사용 처리 중 서버 오류: " + error.message, false);
      })
      .markCouponAsUsed(barcode);
  }

  function openUsageModal(barcode, currentBalance) {
    const modalElement = document.getElementById('usageModal');
    const modalContent = modalElement ? modalElement.firstElementChild : null;

    document.getElementById('usageBarcode').value = barcode;
    document.getElementById('amountUsed').value = '';
    document.getElementById('amountUsed').max = currentBalance;

    if (modalElement && modalContent) {
        modalElement.classList.remove('opacity-0', 'pointer-events-none');
        modalElement.classList.add('opacity-100', 'pointer-events-auto');
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }
  }

  function closeUsageModal() {
    const modalElement = document.getElementById('usageModal');
    const modalContent = modalElement ? modalElement.firstElementChild : null;

    if (modalElement && modalContent) {
        modalElement.classList.add('opacity-0', 'pointer-events-none');
        modalElement.classList.remove('opacity-100', 'pointer-events-auto');
        modalContent.classList.add('scale-95', 'opacity-0');
        modalContent.classList.remove('scale-100', 'opacity-100');
    }
  }

  function submitUsageForm() {
    showLoading(true);
    var barcode = document.getElementById('usageBarcode').value;
    var amountUsed = parseFloat(document.getElementById('amountUsed').value);

    if (isNaN(amountUsed) || amountUsed <= 0) {
        showMessage("올바른 사용 금액(0보다 큰 값)을 입력해주세요.", false);
        showLoading(false);
        return;
    }

    google.script.run
      .withSuccessHandler(function(jsonStringResponse) {
        showLoading(false);
        try {
          if (typeof jsonStringResponse !== 'string') {
            console.error("submitUsageForm 오류: JSON 문자열이 필요하지만 다음을 받음:", jsonStringResponse);
            showMessage("오류: 서버로부터 잘못된 응답입니다.", false);
            return;
          }
          var response = JSON.parse(jsonStringResponse);

          if (response.success) {
            showMessage(response.message, true);
            closeUsageModal();
            loadAllCoupons(); // This will call updateDashboard in its success handler
          } else {
            showMessage(response.message, false);
          }
        } catch (e) {
          console.error("submitUsageForm JSON.parse 오류:", e, "Original response:", jsonStringResponse);
          showMessage("서버 응답 처리 중 오류: " + e.message, false);
        }
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showMessage("사용내역 기록 중 클라이언트 오류: " + error.message, false);
      })
      .logGiftCertificateUsage(barcode, amountUsed);
  }

  function openNewCouponModal() {
    if (!newCouponModalElement) newCouponModalElement = document.getElementById('newCouponModal');
    const modalContent = newCouponModalElement ? newCouponModalElement.firstElementChild : null;

    // Clear form fields
    document.getElementById('newCouponProductName').value = '';
    document.getElementById('newCouponBarcode').value = '';
    document.getElementById('newCouponExpiryDate').value = '';
    document.getElementById('newCouponExpiryDate').type = 'text'; // Ensure it resets from 'date'
    document.getElementById('newCouponIsGift').checked = false;
    document.getElementById('newCouponInitialBalance').value = '';

    var imgFile = document.getElementById('newCouponImageFile');
    if(imgFile) imgFile.value = ''; // Clear file input
    var camFile = document.getElementById('newCouponCameraFile');
    if(camFile) camFile.value = ''; // Clear camera input

    var imagePreview = document.getElementById('newCouponImagePreview');
    imagePreview.src = '#';
    imagePreview.style.display = 'none'; // Keep this for preview logic, or integrate with Tailwind

    selectedImageFile = null;
    toggleNewCouponBalanceField(); // Existing logic

    if (newCouponModalElement && modalContent) {
        // Show modal
        newCouponModalElement.classList.remove('opacity-0', 'pointer-events-none');
        newCouponModalElement.classList.add('opacity-100', 'pointer-events-auto');
        // Animate content
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }
  }

  function closeNewCouponModal() {
    if (!newCouponModalElement) newCouponModalElement = document.getElementById('newCouponModal');
    const modalContent = newCouponModalElement ? newCouponModalElement.firstElementChild : null;

    if (newCouponModalElement && modalContent) {
        // Hide modal
        newCouponModalElement.classList.add('opacity-0', 'pointer-events-none');
        newCouponModalElement.classList.remove('opacity-100', 'pointer-events-auto');
        // Animate content out
        modalContent.classList.add('scale-95', 'opacity-0');
        modalContent.classList.remove('scale-100', 'opacity-100');
    }
  }

  // Custom Tab Switching Logic
  document.addEventListener('DOMContentLoaded', function () {
      const mainNavigation = document.getElementById('mainNavigation');
      const tabPanes = document.querySelectorAll('#mainTabContent .tab-pane');
      const navLinks = document.querySelectorAll('#mainNavigation .nav-link');

      if (mainNavigation) {
          mainNavigation.addEventListener('click', function(event) {
              let clickedTabButton = null;
              if (event.target.classList.contains('nav-link')) {
                  clickedTabButton = event.target;
              } else if (event.target.closest('.nav-link')) {
                  clickedTabButton = event.target.closest('.nav-link');
              }

              if (clickedTabButton && !clickedTabButton.classList.contains('active')) {
                  navLinks.forEach(link => {
                      link.classList.remove('active');
                      link.setAttribute('aria-selected', 'false');
                  });
                  tabPanes.forEach(pane => {
                      pane.classList.remove('show', 'active');
                  });

                  clickedTabButton.classList.add('active');
                  clickedTabButton.setAttribute('aria-selected', 'true');
                  const targetPaneId = clickedTabButton.getAttribute('data-bs-target');
                  if (targetPaneId) {
                      const targetPane = document.querySelector(targetPaneId);
                      if (targetPane) {
                          targetPane.classList.add('show', 'active');
                           // 만약 활성화된 탭이 사용 히스토리 탭이면, 히스토리 로드
                          if (targetPaneId === '#usageHistorySection') {
                            loadUsageHistory(null); // 전체 히스토리 로드
                          }
                      }
                  }
              }
              if(event.target.tagName === 'BUTTON' || event.target.closest('.nav-link')) {
                event.preventDefault();
              }
          });
      }

      const defaultActiveTab = document.querySelector('#mainNavigation .nav-link.active');
      if (defaultActiveTab) {
          const targetPaneId = defaultActiveTab.getAttribute('data-bs-target');
          if (targetPaneId) {
              const targetPane = document.querySelector(targetPaneId);
              if (targetPane && !targetPane.classList.contains('show')) {
                  tabPanes.forEach(pane => pane.classList.remove('show', 'active'));
                  targetPane.classList.add('show', 'active');
              }
              // 기본 활성 탭이 사용 히스토리 탭인 경우에도 로드
              if (targetPaneId === '#usageHistorySection' && (!targetPane || !targetPane.classList.contains('show'))) {
                 // loadUsageHistory(null); // This might be too early if tab content isn't fully ready
              } else if (targetPaneId === '#usageHistorySection' && targetPane && targetPane.classList.contains('show')) {
                 loadUsageHistory(null);
              }
          }
      }
  });


  window.onload = function() {
    document.getElementById('filterStartDate').placeholder = 'YYYY-MM-DD (조회 시작일)';
    document.getElementById('filterEndDate').placeholder = 'YYYY-MM-DD (조회 종료일)';

    var today = new Date();

    var startDateInput = document.getElementById('filterStartDate');
    var oneYearAgo = new Date(today);
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    startDateInput.value = formatDate(oneYearAgo);

    var endDateInput = document.getElementById('filterEndDate');
    var tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);
    endDateInput.value = formatDate(tomorrow);

    newCouponModalElement = document.getElementById('newCouponModal');
    document.getElementById('addCouponFab').addEventListener('click', openNewCouponModal);
    document.getElementById('saveNewCouponButton').onclick = submitNewCouponForm;

    var newCouponImageFileInput = document.getElementById('newCouponImageFile');
    if (newCouponImageFileInput) {
        newCouponImageFileInput.addEventListener('change', function(event) {
            previewAndSetFile(event.target.files[0]);
            analyzeImageWithGemini(event.target.files[0]);
        });
    }
    var newCouponCameraFileInput = document.getElementById('newCouponCameraFile');
    if (newCouponCameraFileInput) {
        newCouponCameraFileInput.addEventListener('change', function(event) {
            previewAndSetFile(event.target.files[0]);
            analyzeImageWithGemini(event.target.files[0]);
        });
    }

    var dragDropZone = document.getElementById('dragDropZone');
    if (dragDropZone) {
        dragDropZone.addEventListener('dragover', function(event) {
          event.preventDefault();
          dragDropZone.classList.add('border-blue-500', 'bg-blue-50');
        });
        dragDropZone.addEventListener('dragleave', function(event) {
          event.preventDefault();
          dragDropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });
        dragDropZone.addEventListener('drop', function(event) {
          event.preventDefault();
          dragDropZone.classList.remove('border-blue-500', 'bg-blue-50');
          if (event.dataTransfer.files.length > 0) {
            var droppedFile = event.dataTransfer.files[0];
            previewAndSetFile(droppedFile);
            analyzeImageWithGemini(droppedFile);
            if(newCouponImageFileInput) newCouponImageFileInput.value = '';
            if(newCouponCameraFileInput) newCouponCameraFileInput.value = '';
          }
        });
    }

    loadAllCoupons(); // This will also trigger updateDashboard via its success handler
    updateDashboard(); // Initial dashboard load

    // Check if the initial active tab is the usage history tab and load its content.
    // This is a bit redundant with the DOMContentLoaded logic but ensures it loads if active by default.
    const initialActiveTab = document.querySelector('#mainNavigation .nav-link.active');
    if (initialActiveTab && initialActiveTab.getAttribute('data-bs-target') === '#usageHistorySection') {
        loadUsageHistory(null);
    }
  };

  function formatReadableTimestamp(isoString) {
    if (!isoString) return 'N/A';
    try {
        const date = new Date(isoString);
        if (isNaN(date.getTime())) return isoString; // Return original if not a valid date

        const year = date.getFullYear();
        const month = ('0' + (date.getMonth() + 1)).slice(-2);
        const day = ('0' + date.getDate()).slice(-2);
        const hours = ('0' + date.getHours()).slice(-2);
        const minutes = ('0' + date.getMinutes()).slice(-2);
        const seconds = ('0' + date.getSeconds()).slice(-2);
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    } catch (e) {
        return isoString; // In case of any error with date parsing
    }
  }

  function loadUsageHistory(barcodeToFilter) {
    showLoading(true);
    var tableBody = document.getElementById('usageHistoryTable').getElementsByTagName('tbody')[0];
    tableBody.innerHTML = '<tr><td colspan="4" class="text-center">로딩 중...</td></tr>';

    google.script.run
        .withSuccessHandler(function(jsonStringResponse) {
            showLoading(false);
            tableBody.innerHTML = ''; // Clear loading message
            try {
                var historyRecords = JSON.parse(jsonStringResponse);

                if (historyRecords.error) {
                    console.error("Error loading usage history:", historyRecords.error);
                    showMessage("사용 내역 로딩 중 오류: " + historyRecords.error, false);
                    var row = tableBody.insertRow();
                    var cell = row.insertCell();
                    cell.colSpan = 4;
                    cell.textContent = "오류: " + historyRecords.error;
                    cell.style.textAlign = "center";
                    return;
                }

                if (!Array.isArray(historyRecords) || historyRecords.length === 0) {
                    var row = tableBody.insertRow();
                    var cell = row.insertCell();
                    cell.colSpan = 4;
                    cell.textContent = "사용 내역이 없습니다.";
                    cell.style.textAlign = "center";
                    return;
                }

                historyRecords.forEach(function(record) {
                    var row = tableBody.insertRow();
                    row.insertCell().textContent = formatReadableTimestamp(record.timestamp);
                    row.insertCell().textContent = record.barcode;
                    row.insertCell().textContent = typeof record.amountUsed === 'number' ? record.amountUsed.toFixed(2) : 'N/A';
                    row.insertCell().textContent = typeof record.newBalance === 'number' ? record.newBalance.toFixed(2) : 'N/A';
                });

            } catch (e) {
                console.error("Error parsing usage history response:", e, jsonStringResponse);
                showMessage("사용 내역 응답 처리 중 오류: " + e.message, false);
                var row = tableBody.insertRow();
                var cell = row.insertCell();
                cell.colSpan = 4;
                cell.textContent = "데이터 처리 중 오류가 발생했습니다.";
                cell.style.textAlign = "center";
            }
        })
        .withFailureHandler(function(error) {
            showLoading(false);
            tableBody.innerHTML = ''; // Clear loading message
            showMessage("사용 내역 로딩 중 서버 오류: " + error.message, false);
            console.error("Server error loading usage history:", error);
            var row = tableBody.insertRow();
            var cell = row.insertCell();
            cell.colSpan = 4;
            cell.textContent = "서버 통신 중 오류가 발생했습니다.";
            cell.style.textAlign = "center";
        })
        .getUsageHistory(barcodeToFilter);
  }

  function updateDashboard() {
    // Optional: Show a subtle loading indicator on the dashboard stats if needed
    // document.getElementById('totalCouponsStat').textContent = "로딩중...";
    // etc.

    google.script.run
      .withSuccessHandler(function(responseString) {
        try {
          var stats = JSON.parse(responseString);
          if (stats.error) {
            console.error("대시보드 통계 로딩 오류:", stats.error);
            // It might be better to show a generic error on the stat elements
            // or a specific error message via showMessage for critical errors.
            document.getElementById('totalCouponsStat').textContent = "오류";
            document.getElementById('availableCouponsStat').textContent = "오류";
            document.getElementById('expiringSoonStat').textContent = "오류";
            document.getElementById('totalBalanceStat').textContent = "오류";
            // showMessage("대시보드 통계 로딩 중 오류: " + stats.error, false); // Optional: if you want a banner
            return;
          }

          document.getElementById('totalCouponsStat').textContent = stats.totalCoupons + " 개";
          document.getElementById('availableCouponsStat').textContent = stats.availableCoupons + " 개";
          document.getElementById('expiringSoonStat').textContent = stats.expiringSoonCoupons + " 개";
          
          var balanceValue = parseFloat(stats.totalGiftCertificateBalance || 0);
          var formattedBalance = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(balanceValue);
          document.getElementById('totalBalanceStat').textContent = formattedBalance;

        } catch (e) {
          console.error("대시보드 통계 응답 파싱 오류:", e, responseString);
          document.getElementById('totalCouponsStat').textContent = "데이터 오류";
          document.getElementById('availableCouponsStat').textContent = "데이터 오류";
          document.getElementById('expiringSoonStat').textContent = "데이터 오류";
          document.getElementById('totalBalanceStat').textContent = "데이터 오류";
          // showMessage("대시보드 통계 응답 처리 중 오류: " + e.message, false); // Optional
        }
      })
      .withFailureHandler(function(error) {
        console.error("대시보드 통계 서버 호출 오류:", error);
        document.getElementById('totalCouponsStat').textContent = "서버 오류";
        document.getElementById('availableCouponsStat').textContent = "서버 오류";
        document.getElementById('expiringSoonStat').textContent = "서버 오류";
        document.getElementById('totalBalanceStat').textContent = "서버 오류";
        // showMessage("대시보드 통계 로딩 중 서버 통신 오류: " + error.message, false); // Optional
      })
      .getDashboardStats();
  }
</script>
</body>
</html>
