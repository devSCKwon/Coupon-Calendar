<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>쿠폰 관리 시스템</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* --- Base (Mobile-First) Styles --- */
    /* Derived from original @media (max-width: 480px) and merged with original base */
    body {
        font-family: 'Roboto', 'Noto Sans KR', sans-serif;
        line-height: 1.6;
        background-color: #f8f9fa;
        color: #212529;
        padding: 0.625rem; /* 10px */
        font-size: 0.9rem;
    }
    .container-fluid {
        padding-left: 0.3125rem; /* 5px */
        padding-right: 0.3125rem; /* 5px */
    }
    .custom-section-container {
        background-color: #fff;
        padding: 0.625rem; /* 10px */
        margin-bottom: 0.9375rem; /* 15px */
        border-radius: 0.375rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
    }
    #navigationSection.custom-section-container {
        padding-top: 0.625rem; /* 10px */
        padding-bottom: 0;
    }
    h1, h2, h3 {
        color: #2c3e50;
        font-weight: 700;
    }
    h1.text-center { font-size: 1.5rem; }
    h2 {
        font-size: 1.25rem;
        border-bottom: 0.125rem solid #dee2e6; /* 2px */
        padding-bottom: 0.5em;
        margin-bottom: 1em;
        margin-top: 0.5em;
    }
    #dashboardSection + #navigationSection h2,
    #contentSections > .tab-pane > h2 {
        margin-top: 0;
    }
    .modal-content-base {
        background-color: #fff;
        margin: 5% auto;
        padding: 0;
        border: 0.0625rem solid rgba(0,0,0,.2); /* 1px */
        border-radius: 0.5rem;
        width: 98%;
        max-width: 34.375rem; /* 550px */
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
        position: relative;
        display: flex;
        flex-direction: column;
    }
    .custom-modal-header, .custom-modal-body, .custom-modal-footer {
        padding: 0.75rem;
    }
    .custom-modal-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        border-bottom: 0.0625rem solid #dee2e6; /* 1px */
        border-top-left-radius: calc(0.5rem - 0.0625rem); /* 1px */
        border-top-right-radius: calc(0.5rem - 0.0625rem); /* 1px */
    }
    .custom-modal-title {
        font-size: 1.1rem;
        margin-bottom: 0;
        line-height: 1.5;
        font-weight: 500;
    }
    .custom-modal-body {
        position: relative;
        flex: 1 1 auto;
    }
    .custom-modal-footer {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-end;
        border-top: 0.0625rem solid #dee2e6; /* 1px */
        border-bottom-right-radius: calc(0.5rem - 0.0625rem); /* 1px */
        border-bottom-left-radius: calc(0.5rem - 0.0625rem); /* 1px */
    }
    .custom-modal-footer > .btn {
        margin-left: 0.25rem;
    }

    #allCouponsTable th {
        white-space: nowrap;
        background-color: #f8f9fa;
    }
    .coupon-fully-used {
        text-decoration: line-through;
        color: #6c757d !important;
        background-color: #e9ecef !important;
    }
     .coupon-fully-used .btn {
       pointer-events: none;
       opacity: 0.65;
    }
    .expired td {
        background-color: #f8d7da !important;
        color: #58151c !important;
    }
    .nearing-expiry td {
        background-color: #fff3cd !important;
        color: #664d03 !important;
    }
    .modal-base {
        display: none;
        position: fixed;
        z-index: 1055;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow-x: hidden;
        overflow-y: auto;
        background-color: rgba(0,0,0,0.5);
    }
    .custom-close-button {
         box-sizing: content-box;
         width: 1em;
         height: 1em;
         padding: .25em .25em;
         color: #000;
         background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat;
         border: 0;
         border-radius: .25rem;
         opacity: .5;
         cursor: pointer;
         font-size: 1.5rem;
     }
     .custom-close-button:hover {
         opacity: .75;
     }
    #loading {
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        text-align: center;
        padding: 2rem;
        font-size: 1rem;
        color: #fff;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.65);
        z-index:1100;
    }
    .fab {
       position: fixed;
       bottom: 0.9375rem; /* 15px */
       right: 0.9375rem; /* 15px */
       width: 3rem; /* 48px */
       height: 3rem; /* 48px */
       background-color: #0d6efd;
       color: white;
       border: none;
       border-radius: 50%;
       font-size: 1.25rem; /* 20px */
       display: flex;
       align-items: center;
       justify-content: center;
       box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.2), 0 0 0 0.125rem rgba(255,255,255,0.1) inset; /* 4px 8px, 2px */
       cursor: pointer;
       z-index: 1040;
       transition: background-color 0.2s ease, transform 0.2s ease;
   }
   .fab:hover {
       background-color: #0b5ed7;
       transform: scale(1.05);
   }
   .fab i {
   }
   #newCouponModalBody h4 {
       font-size: 1rem;
       margin-top: 0.75rem;
   }
   #newCouponModalBody h4:first-child {
       margin-top: 0;
   }
   .image-upload-area {
       padding: 1rem;
       border: 0.125rem dashed #adb5bd; /* 2px */
       border-radius: 0.25rem;
       text-align: center;
       background-color: #f8f9fa;
       margin-bottom: 1rem;
   }
   .drag-drop-zone {
       padding: 1rem;
       margin-bottom: 0.75rem;
   }
   .drag-drop-zone p {
       margin: 0;
       font-size: 0.9em;
       color: #6c757d;
   }
   .drag-drop-zone.dragover {
        border-color: #0d6efd;
        background-color: #e9ecef;
   }
   #newCouponImagePreview {
       margin-top: 1rem;
       max-width: 100%;
       max-height: 11.25rem; /* 180px */
       border: 0.0625rem solid #dee2e6; /* 1px */
       padding: 0.25rem;
       border-radius: 0.25rem;
   }
   .required-star {
       color: #dc3545;
       margin-left: 0.125rem;
   }
   #newCouponModal .modal-content-base .modal-actions {
        text-align: right;
        margin-top: 1.5rem;
        border-top: 0.0625rem solid #dee2e6; /* 1px */
        padding-top: 1rem;
   }
    #mainNavigation {
        margin-bottom: 1.5rem;
    }
    #mainNavigation .nav-link {
        color: #0d6efd;
        font-weight: 500;
        border-bottom: 0.1875rem solid transparent; /* 3px */
        border-radius: 0;
        font-size: 0.8rem;
        padding: 0.5rem 0.2rem;
    }
    #mainNavigation .nav-link i {
        margin-right: 0.1rem;
        font-size: 0.85rem;
    }
    #mainNavigation .nav-link.active {
        color: #0a58ca;
        background-color: transparent !important;
        border-bottom-color: #0a58ca;
    }
    #mainNavigation .nav-link:not(.active):hover {
        color: #0b5ed7;
        border-bottom-color: #cfe2ff;
    }
    #allCouponsTable { min-width: auto; }
    #allCouponsTable th, #allCouponsTable td { padding: 0.4rem; font-size: 0.8rem; }
    .btn { font-size: 0.85rem; padding: 0.5rem 0.75rem; } /* Increased padding */
    .form-control, .form-select, .form-control-sm { font-size: 0.9rem; padding: 0.5rem 0.75rem; } /* Increased padding */
    .form-label { font-size: 0.9rem; }
    #dashboardSection .card-body { padding: 0.5rem; }
    #dashboardSection .card-title { font-size: 0.85rem; margin-top: 0.15rem !important;}
    #dashboardSection .card-text { font-size: 1.3rem; }
    #dashboardSection .card-body i { font-size: 1.5rem !important; margin-bottom: 0.15rem !important;}
    .filters .btn { width: 100%; }

    /* --- Tablet Styles --- */
    @media (min-width: 576px) {
        body {
            padding: 0;
            font-size: 1rem;
        }
        .container-fluid {
            padding-left: 0.9375rem; /* 15px */
            padding-right: 0.9375rem; /* 15px */
        }
        .custom-section-container {
            padding: 0.9375rem; /* 15px */
            margin-bottom: 1.25rem; /* 20px */
        }
        #navigationSection.custom-section-container {
            padding-top: 0.9375rem; /* 15px */
            padding-bottom: 0.9375rem; /* 15px */
        }
        h1.text-center { font-size: 1.75rem; }
        h2 { font-size: 1.5rem; }
        #allCouponsTable {
           min-width: 37.5rem; /* 600px */
        }
        #allCouponsTable th, #allCouponsTable td { padding: 0.6rem 0.5rem; font-size: inherit; }

        .fab {
            width: 3.5rem; /* 56px */
            height: 3.5rem; /* 56px */
            font-size: 1.5rem; /* 24px */
            bottom: 1.875rem; /* 30px */
            right: 1.875rem; /* 30px */
        }
        #mainNavigation .nav-link {
            font-size: inherit;
            padding-top: 0.75rem; padding-bottom: 0.75rem;
        }
        #mainNavigation .nav-link i {
            margin-right: 0.25rem;
            font-size: 1rem;
        }
        .btn {
            font-size: 1rem;
            padding: 0.375rem 0.75rem;
        }
        .form-control, .form-select, .form-control-sm {
            font-size: 1rem;
            padding: 0.375rem 0.75rem;
        }
        .form-label { font-size: 1rem; }
        #dashboardSection .card-body { padding: 1rem; }
        #dashboardSection .card-title { font-size: 1rem; margin-top: initial !important; }
        #dashboardSection .card-text { font-size: 1.75rem; }
        #dashboardSection .card-body i { font-size: 2rem !important;  margin-bottom: 0.5rem !important; }
        .filters .btn { width: auto; }

        .modal-content-base {
            width: auto;
            margin: 1.75rem auto;
        }
        .custom-modal-header, .custom-modal-body, .custom-modal-footer {
            padding: 1rem;
        }
        .custom-modal-title { font-size: 1.25rem; }
        #newCouponModalBody h4 { font-size: 1.15rem; margin-top: 1rem;}
    }

    /* --- Desktop Styles --- */
    @media (min-width: 992px) {
        h2 {
            font-size: 1.75rem;
        }
        .custom-section-container {
            padding: 1.25rem; /* 20px */
            margin-bottom: 1.5625rem; /* 25px */
        }
        #navigationSection.custom-section-container {
            padding-top: 1.25rem; /* 20px */
            padding-bottom: 1.25rem; /* 20px */
        }
        .modal-content-base {
            max-width: 34.375rem; /* 550px */
        }
       #dashboardSection .card {
           transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
           border: none;
       }
       #dashboardSection .card:hover {
           transform: translateY(-0.3125rem); /* -5px */
           box-shadow: 0 0.5rem 0.9375rem rgba(0,0,0,0.1) !important; /* 8px 15px */
       }
    }

    /* Navigation Toggler */
    .navbar-toggler {
        padding: 0.25rem 0.75rem;
        font-size: 1.25rem;
        line-height: 1;
        background-color: transparent;
        border: 0.0625rem solid transparent; /* 1px */
        border-radius: 0.25rem;
        transition: box-shadow .15s ease-in-out;
        color: #0d6efd;
        margin-bottom: 0.5rem;
    }
    .navbar-toggler:focus {
        text-decoration: none;
        outline: 0;
        box-shadow: 0 0 0 0.25rem;
    }
    .navbar-toggler i {
        font-size: 1.5rem;
        vertical-align: middle;
    }

    /* Collapsible Navigation - Mobile Base */
    #mainNavigationCollapse {
        display: none;
        width: 100%;
    }
    #mainNavigationCollapse.open {
        display: block;
    }

    #mainNavigationCollapse #mainNavigation {
        flex-direction: column;
        align-items: stretch;
        width: 100%;
        margin-bottom: 0;
    }
    #mainNavigationCollapse #mainNavigation .nav-item {
        width: 100%;
    }
    #mainNavigationCollapse #mainNavigation .nav-link {
        text-align: left;
        border-bottom: 0.0625rem solid #eee !important; /* 1px */
        border-radius: 0 !important;
        padding: 0.75rem 1rem !important;
        font-size: 0.9rem;
    }
    #mainNavigationCollapse #mainNavigation .nav-link.active {
        border-left: 0.1875rem solid #0a58ca; /* 3px */
        border-bottom-color: #eee !important;
        background-color: #e9ecef !important;
        font-weight: bold;
    }
     #mainNavigationCollapse #mainNavigation .nav-link i {
        margin-right: 0.5rem;
        font-size: 0.9rem;
    }

    /* Desktop Navigation Styles (Applied above mobile-first general styles) */
    @media (min-width: 992px) { /* lg breakpoint */
        .navbar-toggler {
            display: none !important;
        }
        #mainNavigationCollapse {
            display: flex !important;
            visibility: visible !important;
            height: auto !important;
            width: auto;
            overflow: visible !important;
        }
        #mainNavigation {
             margin-bottom: 1.5rem !important;
        }
        #mainNavigationCollapse #mainNavigation {
            flex-direction: row;
            align-items: center;
        }
        #mainNavigationCollapse #mainNavigation .nav-item {
            width: auto;
        }
        #mainNavigationCollapse #mainNavigation .nav-link {
            text-align: center;
            border-bottom: 0.1875rem solid transparent !important; /* 3px */
            border-left: none;
            padding: 0.75rem 0.75rem !important;
            font-size: 1rem;
            background-color: transparent !important;
            font-weight: 500;
        }
        #mainNavigationCollapse #mainNavigation .nav-link.active {
            border-bottom-color: #0a58ca !important;
            font-weight: bold;
        }
        #mainNavigationCollapse #mainNavigation .nav-link i {
            margin-right: 0.1rem;
            font-size: 0.85rem;
        }
    }
  </style>
</head>
<body>
  <div class="container-fluid pt-3">
    <h1 class="mb-4 text-center">쿠폰 관리 시스템</h1>

    <div id="dashboardSection" class="row text-center mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <i class="bi bi-collection fs-1 text-primary mb-2"></i>
                    <h5 class="card-title mt-2">총 보유쿠폰</h5>
                    <p class="card-text fs-4 fw-bold" id="totalCouponsStat">-- 개</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <i class="bi bi-check-circle fs-1 text-success mb-2"></i>
                    <h5 class="card-title mt-2">사용 가능</h5>
                    <p class="card-text fs-4 fw-bold" id="availableCouponsStat">-- 개</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <i class="bi bi-hourglass-split fs-1 text-warning mb-2"></i>
                    <h5 class="card-title mt-2">만료 예정</h5>
                    <p class="card-text fs-4 fw-bold" id="expiringSoonStat">-- 개</p>
                    <!-- "만료 예정" 기준은 추후 정의 필요 (예: 7일 이내) -->
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column justify-content-center align-items-center">
                    <i class="bi bi-wallet2 fs-1 text-info mb-2"></i>
                    <h5 class="card-title mt-2">총 잔액 (금액권)</h5>
                    <p class="card-text fs-4 fw-bold" id="totalBalanceStat">₩ --</p>
                </div>
            </div>
        </div>
    </div>

    <div id="navigationSection" class="custom-section-container pt-2 pb-0">
        <button class="navbar-toggler d-lg-none" type="button" id="mainNavToggler" aria-label="Toggle navigation" aria-controls="mainNavigationCollapse" aria-expanded="false">
            <i class="bi bi-list"></i>
        </button>
        <div class="collapse navbar-collapse" id="mainNavigationCollapse">
            <ul class="nav nav-pills nav-fill" id="mainNavigation" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="navCouponList-tab" data-bs-target="#couponListSection" type="button" role="tab" aria-controls="couponListSection" aria-selected="true">
                        <i class="bi bi-list-ul me-1"></i>쿠폰 목록
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navCouponRegistration-tab" data-bs-target="#couponRegistrationSection" type="button" role="tab" aria-controls="couponRegistrationSection" aria-selected="false">
                        <i class="bi bi-info-circle me-1"></i>등록 안내
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navUsageHistory-tab" data-bs-target="#usageHistorySection" type="button" role="tab" aria-controls="usageHistorySection" aria-selected="false">
                        <i class="bi bi-clock-history me-1"></i>사용 히스토리
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <div id="contentSections">
        <div class="tab-content" id="mainTabContent">
            <div class="tab-pane fade show active custom-section-container" id="couponListSection" role="tabpanel" aria-labelledby="navCouponList-tab">
                <h2>전체 쿠폰</h2>
                <div class="filters row g-3 align-items-center mb-3">
                  <div class="col-md">
                    <label for="filterStartDate" class="form-label">조회 시작일:</label>
                    <input type="text" id="filterStartDate" class="form-control form-control-sm" onfocus="(this.type='date')">
                  </div>
                  <div class="col-md">
                    <label for="filterEndDate" class="form-label">조회 종료일:</label>
                    <input type="text" id="filterEndDate" class="form-control form-control-sm" onfocus="(this.type='date')">
                  </div>
                  <div class="col-md-auto align-self-end">
                    <button onclick="loadAllCoupons()" class="btn btn-sm btn-primary w-100 mt-3 mt-md-0">필터 적용</button>
                  </div>
                </div>
                <div class="table-responsive">
                  <table id="allCouponsTable" class="table table-striped table-hover table-sm caption-top">
                    <caption>쿠폰 목록</caption>
                    <thead class="table-light">
                      <tr>
                        <th>바코드</th>
                        <th>입력일</th>
                        <th>만료일</th>
                        <th>유형</th>
                        <th>최초 금액</th>
                        <th>잔액</th>
                        <th>이미지 링크</th>
                        <th>사용 완료</th>
                        <th>만료 상태</th>
                        <th>작업</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- 모든 쿠폰이 여기에 로드됩니다 -->
                    </tbody>
                  </table>
                </div>
            </div>
            <div class="tab-pane fade custom-section-container" id="couponRegistrationSection" role="tabpanel" aria-labelledby="navCouponRegistration-tab">
                <div class="text-center p-md-4">
                    <h2 class="mb-3"><i class="bi bi-info-circle-fill text-primary me-2"></i>쿠폰 등록 안내</h2>
                    <p class="lead mb-4">새 쿠폰을 등록하려면 화면 우측 하단의 <button type="button" class="btn btn-danger rounded-circle fab-inline-mention" onclick="document.getElementById('addCouponFab').click();" title="새 쿠폰 추가"><i class="bi bi-plus-lg"></i></button> 버튼을 이용해주세요.</p>
                    <style>.fab-inline-mention { width: 40px; height: 40px; font-size: 16px; line-height: 1; padding: 0; vertical-align: text-bottom;} </style>
                </div>
            </div>
            <div class="tab-pane fade custom-section-container" id="usageHistorySection" role="tabpanel" aria-labelledby="navUsageHistory-tab">
                <h2 class="mb-3"><i class="bi bi-clock-history text-secondary me-2"></i>쿠폰 사용 히스토리</h2>
                <div class="table-responsive">
                    <table id="usageHistoryTable" class="table table-striped table-hover table-sm caption-top">
                        <caption>쿠폰 사용 상세 내역</caption>
                        <thead class="table-light">
                            <tr>
                                <th>시간</th>
                                <th>바코드</th>
                                <th>사용 금액</th>
                                <th>처리 후 잔액</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 사용 내역이 여기에 로드됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div id="statusMessage" role="alert" style="display:none; z-index: 1070;"></div>
  <div id="loading" style="display:none;"></div>

  <button id="addCouponFab" class="fab" title="새 쿠폰 추가"><i class="bi bi-plus-lg"></i></button>

  <div id="newCouponModal" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="newCouponModalLabel">
    <div class="modal-content-base">
        <div class="custom-modal-header">
            <h2 class="custom-modal-title" id="newCouponModalLabel">새 쿠폰 등록</h2>
            <button type="button" class="custom-close-button" onclick="closeNewCouponModal()" aria-label="Close">&times;</button>
        </div>
        <div class="custom-modal-body" id="newCouponModalBody">
            <h4>1. 쿠폰 이미지 등록 (선택 사항)</h4>
            <div class="image-upload-area">
                <div id="dragDropZone" class="drag-drop-zone">
                    <p><i class="bi bi-cloud-arrow-up-fill fs-3 text-muted"></i><br>여기에 이미지를 드래그 앤 드롭하거나<br>아래 버튼을 사용하세요.</p>
                </div>
                <div class="image-upload-buttons">
                    <label for="newCouponImageFile" class="btn btn-success btn-sm"><i class="bi bi-file-earmark-arrow-up"></i> 파일 선택</label>
                    <input type="file" id="newCouponImageFile" accept="image/*" style="display: none;">
                    <label for="newCouponCameraFile" class="btn btn-info btn-sm"><i class="bi bi-camera"></i> 사진 촬영</label>
                    <input type="file" id="newCouponCameraFile" accept="image/*" capture="environment" style="display: none;">
                </div>
                <img id="newCouponImagePreview" src="#" class="img-fluid" alt="이미지 미리보기" style="display: none;">
            </div>
            <hr>
            <h4>2. 쿠폰 정보 입력</h4>
            <div class="form-fields">
                <div class="mb-3">
                    <label for="newCouponProductName" class="form-label">제품명</label>
                    <input type="text" id="newCouponProductName" class="form-control" placeholder="이미지에서 추출된 제품명 (또는 직접 입력)">
                </div>
                <div class="mb-3">
                    <label for="newCouponBarcode" class="form-label">바코드 번호 <span class="required-star">*</span></label>
                    <input type="text" id="newCouponBarcode" class="form-control" placeholder="바코드 스캔 또는 직접 입력" aria-required="true">
                </div>
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="newCouponIsGift" onchange="toggleNewCouponBalanceField()">
                    <label for="newCouponIsGift" class="form-check-label">금액권 (상품권)</label>
                </div>
                <div id="newCouponBalanceGroup" style="display:none;" class="mb-3">
                    <label for="newCouponInitialBalance" class="form-label">초기 금액 <span class="required-star">*</span></label>
                    <input type="number" id="newCouponInitialBalance" class="form-control" placeholder="금액권인 경우 초기 금액 입력" aria-required="true">
                </div>
                <div class="mb-3">
                    <label for="newCouponExpiryDate" class="form-label">만료 일자 <span class="required-star">*</span></label>
                    <input type="text" id="newCouponExpiryDate" class="form-control" placeholder="YYYY-MM-DD" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" aria-required="true">
                </div>
            </div>
        </div>
        <div class="custom-modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeNewCouponModal()">취소</button>
            <button type="button" id="saveNewCouponButton" class="btn btn-primary">저장</button>
        </div>
    </div>
  </div>

  <div id="usageModal" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="usageModalLabel">
    <div class="modal-content-base">
      <div class="custom-modal-header">
        <h3 class="custom-modal-title" id="usageModalLabel">금액권 사용 기록</h3>
        <button type="button" class="custom-close-button" onclick="closeUsageModal()" aria-label="Close">&times;</button>
      </div>
      <div class="custom-modal-body">
        <div class="usage-form">
          <input type="hidden" id="usageBarcode">
          <div class="mb-3">
            <label for="amountUsed" class="form-label">사용할 금액:</label>
            <input type="number" id="amountUsed" class="form-control" name="amountUsed" min="0.01" step="0.01" required>
          </div>
        </div>
      </div>
      <div class="custom-modal-footer">
          <button onclick="submitUsageForm()" class="btn btn-success">사용 기록</button>
          <button onclick="closeUsageModal()" class="btn btn-secondary">취소</button>
      </div>
    </div>
  </div>

  <div id="generalCouponUsageModal" class="modal-base" role="dialog" aria-modal="true" aria-labelledby="generalCouponUsageModalLabel">
    <div class="modal-content-base">
      <div class="custom-modal-header">
        <h3 class="custom-modal-title" id="generalCouponUsageModalLabel">일반 쿠폰 사용 처리</h3>
        <button type="button" class="custom-close-button" onclick="closeGeneralCouponUsageModal()" aria-label="Close">&times;</button>
      </div>
      <div class="custom-modal-body">
        <p id="generalCouponConfirmText" class="my-3"></p>
        <input type="hidden" id="generalCouponBarcodeToMark">
      </div>
      <div class="custom-modal-footer">
          <button onclick="submitMarkAsUsed()" class="btn btn-warning">사용 완료 처리</button>
          <button onclick="closeGeneralCouponUsageModal()" class="btn btn-secondary">취소</button>
      </div>
    </div>
  </div>

<script>
  var newCouponModalElement;
  var selectedImageFile = null;

  function analyzeImageWithGemini(file) {
      if (!file) {
          showMessage("분석할 이미지 파일이 선택되지 않았습니다.", false);
          return;
      }
      showLoading(true); // 로딩 시작

      var reader = new FileReader();
      reader.onload = function(e) {
          var base64ImageData = "";
          if (e.target.result.includes(',')) {
              base64ImageData = e.target.result.split(',')[1]; // Get only the base64 part
          } else {
              base64ImageData = e.target.result;
          }

          var promptText = `이 이미지는 쿠폰입니다. 다음 정보를 추출하여 JSON 객체 형식으로만 응답해주세요. 다른 설명은 추가하지 마세요.:
- "productName": 제품 또는 서비스의 이름 (예: "빅맥 단품", "스타벅스 아메리카노 Tall")
- "barcodeNumber": 바코드 숫자 (공백이나 하이픈 없이 숫자만)
- "expiryDate": 만료일자 (YYYY-MM-DD 형식)
- "amount": 금액권인 경우 그 금액 (숫자만, 예: 30000). 금액권이 아니거나 금액을 알 수 없으면 null.

정보를 찾을 수 없는 필드는 결과 JSON 객체에서 해당 키를 생략하거나 값으로 null을 사용해주세요. 예시: {"productName": "아메리카노", "barcodeNumber": "123456789012", "expiryDate": "2024-12-31", "amount": null}`;

          console.log("Gemini API 요청 중...");
          google.script.run
              .withSuccessHandler(onGeminiSuccess)
              .withFailureHandler(onGeminiFailure)
              .callGeminiApiForImageAnalysis(base64ImageData, promptText);
      };
      reader.onerror = function(error) {
          showLoading(false);
          showMessage("파일을 읽는 중 오류가 발생했습니다: " + error.toString(), false);
          console.error('FileReader error: ', error);
      };
      reader.readAsDataURL(file); // Start reading the file
  }

  function onGeminiSuccess(responseText) {
      showLoading(false);
      console.log("Gemini API 응답 수신:", responseText);
      try {
          if (responseText === null || typeof responseText !== 'string' || responseText.trim() === "") {
              throw new Error("API로부터 유효하지 않거나 빈 응답을 받았습니다.");
          }

          let jsonString = responseText; // Start with the original response
          const firstBracket = jsonString.indexOf('{');
          const firstSquareBracket = jsonString.indexOf('[');
          let start = -1;

          // Determine the starting position of the JSON (either { or [)
          if (firstBracket !== -1 && (firstSquareBracket === -1 || firstBracket < firstSquareBracket)) {
              start = firstBracket;
          } else if (firstSquareBracket !== -1) {
              start = firstSquareBracket;
          } else {
              // No JSON structure found, throw error before trying to find end
              throw new Error("응답에서 유효한 JSON 시작 문자를 찾을 수 없습니다. 원본 응답: " + responseText);
          }

          // Determine the corresponding end bracket and its position
          let end = -1;
          if (jsonString.charAt(start) === '{') { // If JSON starts with {, look for corresponding }
              end = jsonString.lastIndexOf('}');
          } else { // If JSON starts with [, look for corresponding ]
              end = jsonString.lastIndexOf(']');
          }

          if (end === -1 || end < start) {
              throw new Error("응답에서 유효한 JSON 끝 문자를 찾을 수 없습니다. (start: " + start + ", end: " + end + "). 원본 응답: " + responseText);
          }

          jsonString = jsonString.substring(start, end + 1); // Extract the substring

          var resultObject = JSON.parse(jsonString);
          console.log("파싱된 Gemini 결과 객체:", resultObject);

          let productNameExtracted = false;
          let barcodeExtracted = false;
          let expiryDateExtracted = false;
          let amountExtracted = false;

          if (resultObject.productName && typeof resultObject.productName === 'string') {
              document.getElementById('newCouponProductName').value = resultObject.productName;
              productNameExtracted = true;
              console.log("제품명 입력:", resultObject.productName);
          }

          if (resultObject.barcodeNumber && typeof resultObject.barcodeNumber === 'string') {
              document.getElementById('newCouponBarcode').value = resultObject.barcodeNumber.replace(/\D/g, ''); // Ensure only digits
              barcodeExtracted = true;
              console.log("바코드 입력:", resultObject.barcodeNumber.replace(/\D/g, ''));
          }

          if (resultObject.expiryDate && typeof resultObject.expiryDate === 'string') {
              if (/^\d{4}-\d{2}-\d{2}$/.test(resultObject.expiryDate)) {
                  document.getElementById('newCouponExpiryDate').value = resultObject.expiryDate;
                  document.getElementById('newCouponExpiryDate').type = 'date';
                  expiryDateExtracted = true;
                  console.log("만료일자 입력:", resultObject.expiryDate);
              } else {
                  console.warn("수신된 만료일자 형식이 YYYY-MM-DD가 아닙니다:", resultObject.expiryDate);
              }
          }

          if (resultObject.amount !== undefined && resultObject.amount !== null && !isNaN(parseFloat(resultObject.amount))) {
              var numericAmount = parseFloat(resultObject.amount);
              if (numericAmount > 0) {
                  document.getElementById('newCouponInitialBalance').value = numericAmount;
                  document.getElementById('newCouponIsGift').checked = true;
                  amountExtracted = true;
                  console.log("금액 입력:", numericAmount);
              } else {
                  document.getElementById('newCouponIsGift').checked = false;
              }
          } else {
              document.getElementById('newCouponIsGift').checked = false;
          }
          toggleNewCouponBalanceField();

          let finalMessage = "";
          let allSuccess = true;

          if (productNameExtracted && barcodeExtracted && expiryDateExtracted && amountExtracted) {
              finalMessage = "이미지에서 모든 정보를 추출하여 입력했습니다. 내용을 확인해주세요.";
          } else if (productNameExtracted || barcodeExtracted || expiryDateExtracted || amountExtracted) {
              let extractedParts = [];
              if (productNameExtracted) extractedParts.push("제품명");
              if (barcodeExtracted) extractedParts.push("바코드");
              if (expiryDateExtracted) extractedParts.push("만료일");
              if (amountExtracted) extractedParts.push("금액");
              finalMessage = `이미지에서 일부 정보(${extractedParts.join(', ')})만 추출했습니다. 나머지는 직접 확인 후 입력해주세요.`;
              allSuccess = false;
          } else {
              finalMessage = "이미지에서 자동 정보 추출에 실패했습니다. 직접 입력해주세요.";
              allSuccess = false;
          }
          showMessage(finalMessage, allSuccess);

      } catch (e) {
          console.error("Gemini 응답 파싱 오류:", e, "원본 응답:", responseText);
          showMessage("이미지 분석 결과 처리 중 오류 발생: " + e.message + ". 서버 로그를 확인해주세요.", false);
      }
  }

  function onGeminiFailure(error) {
      showLoading(false);
      console.error("Gemini API 호출 실패 객체:", error); // Log the full error object
      showMessage("이미지 분석 API 호출 중 서버 오류 발생: " + error.message, false);
  }

  function showLoading(isLoading) {
    var loader = document.getElementById('loading');
    if (isLoading) {
        loader.innerHTML = '<div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">로딩 중...</span></div><p class="mt-3 text-light fs-5">로딩 중...</p>';
        loader.style.display = 'flex';
    } else {
        loader.style.display = 'none';
    }
  }

  function showMessage(message, isSuccess) {
    var msgDiv = document.getElementById('statusMessage');
    msgDiv.textContent = message;
    msgDiv.className = 'alert ' + (isSuccess ? 'alert-success' : 'alert-danger') + ' show fade';
    msgDiv.style.display = 'block';
    setTimeout(() => {
        msgDiv.classList.remove('show');
        setTimeout(() => { msgDiv.style.display = 'none'; msgDiv.className = 'alert';}, 150);
    }, 5000);
  }

  function toggleNewCouponBalanceField() {
    var isGiftChecked = document.getElementById('newCouponIsGift').checked;
    var balanceGroup = document.getElementById('newCouponBalanceGroup');
    var balanceInput = document.getElementById('newCouponInitialBalance');
    if (isGiftChecked) {
      balanceGroup.style.display = 'block';
    } else {
      balanceGroup.style.display = 'none';
      balanceInput.value = '';
    }
  }

  function formatDate(dateObj) {
    if (!dateObj) return '';
    if (typeof dateObj === 'string') {
        const d = new Date(dateObj);
        if (!isNaN(d.getTime())) {
             return d.toISOString().split('T')[0];
        }
        return dateObj;
    }
    if (typeof dateObj === 'object' && dateObj.getTime) {
       return dateObj.toISOString().split('T')[0];
    }
    const d = new Date(dateObj);
    return d.toISOString().split('T')[0];
  }

  function previewAndSetFile(file) {
    var imagePreview = document.getElementById('newCouponImagePreview');
    if (file && file.type.startsWith('image/')) {
      selectedImageFile = file;
      var reader = new FileReader();
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        imagePreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      selectedImageFile = null;
      imagePreview.src = '#';
      imagePreview.style.display = 'none';
      if (file) {
         showMessage("이미지 파일만 선택 가능합니다. (image/*)", false);
      }
    }
  }

  function submitNewCouponForm() {
    showLoading(true);
    var barcode = document.getElementById('newCouponBarcode').value;
    var expiryDate = document.getElementById('newCouponExpiryDate').value;
    var isGift = document.getElementById('newCouponIsGift').checked;
    var initialBalance = document.getElementById('newCouponInitialBalance').value;

    if (!barcode || !expiryDate) {
        showMessage("바코드와 만료일은 필수 항목입니다.", false);
        showLoading(false);
        return;
    }
    if (isGift && (!initialBalance || parseFloat(initialBalance) < 0)) {
        showMessage("금액권의 초기 금액은 0 이상의 유효한 숫자여야 합니다.", false);
        showLoading(false);
        return;
    }

    var couponData = {
        barcode: barcode,
        expiryDate: expiryDate,
        isGiftCertificate: isGift,
        initialBalance: isGift ? parseFloat(initialBalance) : null
    };

    if (selectedImageFile) {
        showMessage("이미지 업로드 중...", true);
        var reader = new FileReader();
        reader.onload = function(e) {
            var base64ImageData = e.target.result;
            var mimeType = selectedImageFile.type || base64ImageData.substring(base64ImageData.indexOf(':') + 1, base64ImageData.indexOf(';'));
            var fileExtension = selectedImageFile.name.split('.').pop() || mimeType.split('/')[1] || "png";
            var fileName = "coupon_" + (barcode.replace(/\D/g, "") || "img") + "_" + new Date().getTime() + "." + fileExtension;

            google.script.run
                .withSuccessHandler(function(uploadResponseString) {
                    try {
                        var uploadResponse = JSON.parse(uploadResponseString);
                        if (uploadResponse.success) {
                            couponData.imageFileId = uploadResponse.fileId;
                            couponData.imageWebViewLink = uploadResponse.webViewLink;
                            saveFinalCouponData(couponData);
                        } else {
                            showLoading(false);
                            showMessage("이미지 업로드 실패: " + uploadResponse.message, false);
                        }
                    } catch (parseErr) {
                        showLoading(false); console.error("Img Upload Parse Err:", parseErr, uploadResponseString);
                        showMessage("이미지 업로드 응답 오류: " + parseErr.message, false);
                    }
                })
                .withFailureHandler(function(err) {
                    showLoading(false); showMessage("이미지 업로드 서버 오류: " + err.message, false);
                })
                .uploadImageToDrive(base64ImageData, fileName, mimeType);
        };
        reader.onerror = function() {
            showLoading(false); showMessage("이미지 파일 읽기 오류.", false);
        };
        reader.readAsDataURL(selectedImageFile);
    } else {
        saveFinalCouponData(couponData);
    }
  }

  function saveFinalCouponData(dataToSave) {
    if(!document.getElementById('loading').style.display || document.getElementById('loading').style.display === 'none') {
        showLoading(true);
    }
    if (!dataToSave.imageFileId) {
         showMessage("쿠폰 정보 저장 중...", true);
    }

    google.script.run
        .withSuccessHandler(function(saveResponseString) {
            showLoading(false);
            try {
                var saveResponse = JSON.parse(saveResponseString);
                showMessage(saveResponse.message, saveResponse.success);
                if (saveResponse.success) {
                    openNewCouponModal();
                    closeNewCouponModal();
                    loadAllCoupons(); // This will call updateDashboard in its success handler
                }
            } catch (parseErr) {
                console.error("Save Coupon Parse Err:", parseErr, saveResponseString);
                showMessage("쿠폰 저장 응답 오류: " + parseErr.message, false);
            }
        })
        .withFailureHandler(function(err) {
            showLoading(false); showMessage("쿠폰 저장 서버 오류: " + err.message, false);
        })
        .saveCoupon(dataToSave);
  }

  function loadLatestCoupons() { /* Commented out as section is removed */ }

  function loadAllCoupons() {
    showLoading(true);
    var filterStartDate = document.getElementById('filterStartDate').value;
    var filterEndDate = document.getElementById('filterEndDate').value;

    google.script.run
      .withSuccessHandler(function(jsonStringResponse) {
        showLoading(false);
        var tableBody = document.getElementById('allCouponsTable').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';
        try {
          if (typeof jsonStringResponse !== 'string') {
            console.error("loadAllCoupons 오류: JSON 문자열이 필요하지만 다음을 받음:", jsonStringResponse);
            var row = tableBody.insertRow();
            var cell = row.insertCell();
            cell.colSpan = 10;
            cell.textContent = "오류: 서버로부터 잘못된 형식의 데이터가 수신되었습니다.";
            cell.style.textAlign = "center";
            updateDashboard(); // Update dashboard even on this error path
            return;
          }
          var allCoupons = JSON.parse(jsonStringResponse);

          if (!Array.isArray(allCoupons)) {
              console.error("loadAllCoupons 오류: 파싱된 데이터가 배열이 아님:", allCoupons);
              allCoupons = [];
          }

          var filteredCoupons = allCoupons.filter(function(coupon) {
            if (!coupon || typeof coupon !== 'object') return false;
            var entry = coupon.entryDate ? new Date(coupon.entryDate) : null;
            if (!entry) return false;

            if (filterStartDate && entry < new Date(filterStartDate)) {
                return false;
            }
            if (filterEndDate) {
                let endDate = new Date(filterEndDate);
                endDate.setHours(23,59,59,999);
                if (entry > endDate) return false;
            }
            return true;
          });

          if (filteredCoupons.length > 0) {
            filteredCoupons.forEach(function(coupon) {
              if (!coupon || typeof coupon !== 'object') return;
              var row = tableBody.insertRow();

              // Barcode cell - now a clickable link
              var barcodeCell = row.insertCell();
              var barcodeLink = document.createElement('a');
              barcodeLink.href = "javascript:void(0);";
              barcodeLink.textContent = coupon.barcode;
              barcodeLink.style.cursor = "pointer";
              barcodeLink.style.textDecoration = "underline";
              barcodeLink.onclick = function(event) {
                  event.preventDefault();
                  
                  // Programmatically switch to the "사용 히스토리" tab
                  var historyTabButton = document.getElementById('navUsageHistory-tab');
                  var historyPane = document.getElementById('usageHistorySection');
                  
                  // Deactivate other tabs/panes
                  document.querySelectorAll('#mainNavigation .nav-link.active').forEach(function(activeLink) {
                      activeLink.classList.remove('active');
                      activeLink.setAttribute('aria-selected', 'false');
                  });
                  document.querySelectorAll('#mainTabContent .tab-pane.show.active').forEach(function(activePane) {
                      activePane.classList.remove('show', 'active');
                  });

                  // Activate history tab/pane
                  if (historyTabButton) {
                      historyTabButton.classList.add('active');
                      historyTabButton.setAttribute('aria-selected', 'true');
                  }
                  if (historyPane) {
                      historyPane.classList.add('show', 'active');
                  }
                  
                  // Load history for the clicked barcode
                  // Ensure coupon.barcode is the normalized version if that's what getUsageHistory expects
                  loadUsageHistory(coupon.barcode); 
              };
              barcodeCell.appendChild(barcodeLink);

              row.insertCell().textContent = formatDate(new Date(coupon.entryDate));

              var expiryCell = row.insertCell();
              var expiryDate = new Date(coupon.expiryDate);
              expiryCell.textContent = formatDate(expiryDate);

              var today = new Date();
              today.setHours(0,0,0,0);

              if (expiryDate < today && coupon.expiryStatus === '사용가능') {
                row.classList.add('expired');
              } else if (!row.classList.contains('expired') && (expiryDate - today) / (1000 * 60 * 60 * 24) <= 7 && coupon.expiryStatus === '사용가능') {
                row.classList.add('nearing-expiry');
              }

              if (coupon.expiryStatus === '사용완료' || coupon.expiryStatus === '잔액없음') {
                row.classList.add('coupon-fully-used');
              }

              row.insertCell().textContent = coupon.isGiftCertificate ? '금액권' : '일반 쿠폰';
              row.insertCell().textContent = coupon.isGiftCertificate && coupon.originalAmount !== null ? parseFloat(coupon.originalAmount).toFixed(2) : 'N/A';
              row.insertCell().textContent = coupon.isGiftCertificate && coupon.balance !== null ? parseFloat(coupon.balance).toFixed(2) : 'N/A';

              var imageLinkCell = row.insertCell();
              if (coupon.imageWebViewLink) {
                var link = document.createElement('a');
                link.href = coupon.imageWebViewLink;
                link.textContent = "이미지 보기";
                link.target = "_blank";
                imageLinkCell.appendChild(link);
              } else {
                imageLinkCell.textContent = "N/A";
              }

              row.insertCell().textContent = coupon.isUsed ? '예' : '아니오';
              row.insertCell().textContent = coupon.expiryStatus;

              var actionsCell = row.insertCell();
              actionsCell.innerHTML = '';
              if (coupon.expiryStatus === '사용가능') {
                if (coupon.isGiftCertificate) {
                  var useButton = document.createElement('button');
                  useButton.className = 'btn btn-sm btn-success';
                  useButton.innerHTML = '<i class="bi bi-cash-coin"></i> 사용';
                  useButton.onclick = function() { openUsageModal(coupon.barcode, coupon.balance); };
                  actionsCell.appendChild(useButton);
                } else {
                  var markUsedButton = document.createElement('button');
                  markUsedButton.className = 'btn btn-sm btn-primary';
                  markUsedButton.innerHTML = '<i class="bi bi-check-lg"></i> 사용 처리';
                  markUsedButton.onclick = function() { openMarkAsUsedModal(coupon.barcode); };
                  actionsCell.appendChild(markUsedButton);
                }
              } else if (coupon.expiryStatus === '잔액없음') {
                actionsCell.textContent = "잔액 없음";
              } else if (coupon.expiryStatus === '사용완료') {
                actionsCell.textContent = "사용 완료됨";
              } else {
                 actionsCell.textContent = coupon.expiryStatus;
              }
            });
          } else {
            var row = tableBody.insertRow();
            var cell = row.insertCell();
            cell.colSpan = 10;
            cell.textContent = "쿠폰이 없거나 필터 조건에 맞는 쿠폰이 없습니다.";
            cell.style.textAlign = "center";
          }
        } catch (e) {
          console.error("loadAllCoupons JSON.parse 오류:", e, "Original response:", jsonStringResponse);
          var row = tableBody.insertRow();
          var cell = row.insertCell();
          cell.colSpan = 10;
          cell.textContent = "쿠폰 목록 처리 중 오류가 발생했습니다.";
          cell.style.textAlign = "center";
          showMessage("쿠폰 목록 파싱 중 오류: " + e.message, false);
        }
        updateDashboard(); // Call after processing all coupons or if try block failed
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showMessage("전체 쿠폰 로딩 중 오류: " + error.message, false);
        updateDashboard(); // Also update dashboard on failure to reflect error state or clear old data
      })
      .getCoupons();
  }

  function openMarkAsUsedModal(barcode) {
    document.getElementById('generalCouponBarcodeToMark').value = barcode;
    document.getElementById('generalCouponConfirmText').textContent = "'" + barcode + "' 쿠폰을 사용 완료로 처리하시겠습니까?";
    document.getElementById('generalCouponUsageModal').style.display = 'block';
  }

  function closeGeneralCouponUsageModal() {
    var generalModal = document.getElementById('generalCouponUsageModal');
    if(generalModal) generalModal.style.display = 'none';
  }

  function submitMarkAsUsed() {
    var barcode = document.getElementById('generalCouponBarcodeToMark').value;
    if (!barcode) {
      showMessage("오류: 처리할 쿠폰 바코드가 없습니다.", false);
      return;
    }
    showLoading(true);
    google.script.run
      .withSuccessHandler(function(responseString) {
        showLoading(false);
        try {
          var response = JSON.parse(responseString);
          showMessage(response.message, response.success);
          if (response.success) {
            closeGeneralCouponUsageModal();
            loadAllCoupons(); // This will call updateDashboard in its success handler
          }
        } catch (e) {
          console.error("submitMarkAsUsed JSON.parse error:", e, "Original response:", responseString);
          showMessage("서버 응답 처리 오류: " + e.message, false);
        }
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showMessage("쿠폰 사용 처리 중 서버 오류: " + error.message, false);
      })
      .markCouponAsUsed(barcode);
  }

  function openUsageModal(barcode, currentBalance) {
    document.getElementById('usageBarcode').value = barcode;
    document.getElementById('amountUsed').value = '';
    document.getElementById('amountUsed').max = currentBalance;
    document.getElementById('usageModal').style.display = 'block';
  }

  function closeUsageModal() {
    var usageModal = document.getElementById('usageModal');
    if(usageModal) usageModal.style.display = 'none';
  }

  function submitUsageForm() {
    showLoading(true);
    var barcode = document.getElementById('usageBarcode').value;
    var amountUsed = parseFloat(document.getElementById('amountUsed').value);

    if (isNaN(amountUsed) || amountUsed <= 0) {
        showMessage("올바른 사용 금액(0보다 큰 값)을 입력해주세요.", false);
        showLoading(false);
        return;
    }

    google.script.run
      .withSuccessHandler(function(jsonStringResponse) {
        showLoading(false);
        try {
          if (typeof jsonStringResponse !== 'string') {
            console.error("submitUsageForm 오류: JSON 문자열이 필요하지만 다음을 받음:", jsonStringResponse);
            showMessage("오류: 서버로부터 잘못된 응답입니다.", false);
            return;
          }
          var response = JSON.parse(jsonStringResponse);

          if (response.success) {
            showMessage(response.message, true);
            closeUsageModal();
            loadAllCoupons(); // This will call updateDashboard in its success handler
          } else {
            showMessage(response.message, false);
          }
        } catch (e) {
          console.error("submitUsageForm JSON.parse 오류:", e, "Original response:", jsonStringResponse);
          showMessage("서버 응답 처리 중 오류: " + e.message, false);
        }
      })
      .withFailureHandler(function(error) {
        showLoading(false);
        showMessage("사용내역 기록 중 클라이언트 오류: " + error.message, false);
      })
      .logGiftCertificateUsage(barcode, amountUsed);
  }

  function openNewCouponModal() {
    if (!newCouponModalElement) newCouponModalElement = document.getElementById('newCouponModal');

    document.getElementById('newCouponBarcode').value = '';
    document.getElementById('newCouponExpiryDate').value = '';
    document.getElementById('newCouponExpiryDate').type = 'text';
    document.getElementById('newCouponIsGift').checked = false;
    document.getElementById('newCouponInitialBalance').value = '';

    var imgFile = document.getElementById('newCouponImageFile');
    if(imgFile) imgFile.value = '';
    var camFile = document.getElementById('newCouponCameraFile');
    if(camFile) camFile.value = '';

    var imagePreview = document.getElementById('newCouponImagePreview');
    imagePreview.src = '#';
    imagePreview.style.display = 'none';

    selectedImageFile = null;

    toggleNewCouponBalanceField();
    newCouponModalElement.style.display = 'block';
  }

  function closeNewCouponModal() {
    if (!newCouponModalElement) newCouponModalElement = document.getElementById('newCouponModal');
    newCouponModalElement.style.display = 'none';
  }

  // Custom Tab Switching Logic
  document.addEventListener('DOMContentLoaded', function () {
      const mainNavigationUL = document.getElementById('mainNavigation'); // Renamed for clarity
      const tabPanes = document.querySelectorAll('#mainTabContent .tab-pane');
      const navLinks = document.querySelectorAll('#mainNavigation .nav-link'); // These are the buttons inside list items
      const mainNavigationCollapse = document.getElementById('mainNavigationCollapse');
      const mainNavTogglerButton = document.getElementById('mainNavToggler');

      if (mainNavigationUL) {
          mainNavigationUL.addEventListener('click', function(event) {
              let clickedTabButton = null;
              // Find the actual button if a click happened on its child (like an icon)
              if (event.target.classList.contains('nav-link')) {
                  clickedTabButton = event.target;
              } else if (event.target.closest('.nav-link')) {
                  clickedTabButton = event.target.closest('.nav-link');
              }

              if (clickedTabButton && !clickedTabButton.classList.contains('active')) {
                  navLinks.forEach(link => {
                      link.classList.remove('active');
                      link.setAttribute('aria-selected', 'false');
                  });
                  tabPanes.forEach(pane => {
                      pane.classList.remove('show', 'active');
                  });

                  clickedTabButton.classList.add('active');
                  clickedTabButton.setAttribute('aria-selected', 'true');
                  const targetPaneId = clickedTabButton.getAttribute('data-bs-target');
                  if (targetPaneId) {
                      const targetPane = document.querySelector(targetPaneId);
                      if (targetPane) {
                          targetPane.classList.add('show', 'active');
                          if (targetPaneId === '#usageHistorySection') {
                            loadUsageHistory(null);
                          }
                      }
                  }
              }

              // If mobile menu is open, close it after a tab is clicked
              if (mainNavigationCollapse && mainNavigationCollapse.classList.contains('open')) {
                  mainNavigationCollapse.classList.remove('open');
                  if (mainNavTogglerButton) {
                      const togglerIcon = mainNavTogglerButton.querySelector('i');
                      if (togglerIcon) {
                          togglerIcon.classList.remove('bi-x');
                          togglerIcon.classList.add('bi-list');
                      }
                  }
              }

              // Prevent default if the clicked element was a button or inside a nav-link
              if(event.target.tagName === 'BUTTON' || event.target.closest('.nav-link')) {
                event.preventDefault();
              }
          });
      }

      const defaultActiveTab = document.querySelector('#mainNavigation .nav-link.active');
      if (defaultActiveTab) {
          const targetPaneId = defaultActiveTab.getAttribute('data-bs-target');
          if (targetPaneId) {
              const targetPane = document.querySelector(targetPaneId);
              if (targetPane && !targetPane.classList.contains('show')) {
                  tabPanes.forEach(pane => pane.classList.remove('show', 'active'));
                  targetPane.classList.add('show', 'active');
              }
              // 기본 활성 탭이 사용 히스토리 탭인 경우에도 로드
              if (targetPaneId === '#usageHistorySection' && (!targetPane || !targetPane.classList.contains('show'))) {
                 // loadUsageHistory(null); // This might be too early if tab content isn't fully ready
              } else if (targetPaneId === '#usageHistorySection' && targetPane && targetPane.classList.contains('show')) {
                 loadUsageHistory(null);
              }
          }
      }
  });


  window.onload = function() {
    document.getElementById('filterStartDate').placeholder = 'YYYY-MM-DD (조회 시작일)';
    document.getElementById('filterEndDate').placeholder = 'YYYY-MM-DD (조회 종료일)';

    var today = new Date();

    var startDateInput = document.getElementById('filterStartDate');
    var oneYearAgo = new Date(today);
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    startDateInput.value = formatDate(oneYearAgo);

    var endDateInput = document.getElementById('filterEndDate');
    var tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);
    endDateInput.value = formatDate(tomorrow);

    newCouponModalElement = document.getElementById('newCouponModal');
    document.getElementById('addCouponFab').addEventListener('click', openNewCouponModal);
    document.getElementById('saveNewCouponButton').onclick = submitNewCouponForm;

    initializeMobileNavbarToggler(); // Initialize the new toggler

    var newCouponImageFileInput = document.getElementById('newCouponImageFile');
    if (newCouponImageFileInput) {
        newCouponImageFileInput.addEventListener('change', function(event) {
            previewAndSetFile(event.target.files[0]);
            analyzeImageWithGemini(event.target.files[0]);
        });
    }
    var newCouponCameraFileInput = document.getElementById('newCouponCameraFile');
    if (newCouponCameraFileInput) {
        newCouponCameraFileInput.addEventListener('change', function(event) {
            previewAndSetFile(event.target.files[0]);
            analyzeImageWithGemini(event.target.files[0]);
        });
    }

    var dragDropZone = document.getElementById('dragDropZone');
    if (dragDropZone) {
        dragDropZone.addEventListener('dragover', function(event) {
          event.preventDefault();
          dragDropZone.classList.add('dragover');
        });
        dragDropZone.addEventListener('dragleave', function(event) {
          event.preventDefault();
          dragDropZone.classList.remove('dragover');
        });
        dragDropZone.addEventListener('drop', function(event) {
          event.preventDefault();
          dragDropZone.classList.remove('dragover');
          if (event.dataTransfer.files.length > 0) {
            var droppedFile = event.dataTransfer.files[0];
            previewAndSetFile(droppedFile);
            analyzeImageWithGemini(droppedFile);
            if(newCouponImageFileInput) newCouponImageFileInput.value = '';
            if(newCouponCameraFileInput) newCouponCameraFileInput.value = '';
          }
        });
    }

    loadAllCoupons(); // This will also trigger updateDashboard via its success handler
    updateDashboard(); // Initial dashboard load

    // Check if the initial active tab is the usage history tab and load its content.
    // This is a bit redundant with the DOMContentLoaded logic but ensures it loads if active by default.
    const initialActiveTab = document.querySelector('#mainNavigation .nav-link.active');
    if (initialActiveTab && initialActiveTab.getAttribute('data-bs-target') === '#usageHistorySection') {
        loadUsageHistory(null);
    }
  };

  function initializeMobileNavbarToggler() {
    const mainNavTogglerButton = document.getElementById('mainNavToggler');
    const mainNavigationCollapse = document.getElementById('mainNavigationCollapse');
    const togglerIcon = mainNavTogglerButton ? mainNavTogglerButton.querySelector('i') : null;

    if (mainNavTogglerButton && mainNavigationCollapse && togglerIcon) {
        mainNavTogglerButton.addEventListener('click', function() {
            const isOpening = !mainNavigationCollapse.classList.contains('open');
            mainNavigationCollapse.classList.toggle('open');
            mainNavTogglerButton.setAttribute('aria-expanded', isOpening);

            if (isOpening) {
                togglerIcon.classList.remove('bi-list');
                togglerIcon.classList.add('bi-x');
            } else {
                togglerIcon.classList.remove('bi-x');
                togglerIcon.classList.add('bi-list');
            }
        });
    }
  }

  function formatReadableTimestamp(isoString) {
    if (!isoString) return 'N/A';
    try {
        const date = new Date(isoString);
        if (isNaN(date.getTime())) return isoString; // Return original if not a valid date

        const year = date.getFullYear();
        const month = ('0' + (date.getMonth() + 1)).slice(-2);
        const day = ('0' + date.getDate()).slice(-2);
        const hours = ('0' + date.getHours()).slice(-2);
        const minutes = ('0' + date.getMinutes()).slice(-2);
        const seconds = ('0' + date.getSeconds()).slice(-2);
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    } catch (e) {
        return isoString; // In case of any error with date parsing
    }
  }

  function loadUsageHistory(barcodeToFilter) {
    showLoading(true);
    var tableBody = document.getElementById('usageHistoryTable').getElementsByTagName('tbody')[0];
    tableBody.innerHTML = '<tr><td colspan="4" class="text-center">로딩 중...</td></tr>';

    google.script.run
        .withSuccessHandler(function(jsonStringResponse) {
            showLoading(false);
            tableBody.innerHTML = ''; // Clear loading message
            try {
                var historyRecords = JSON.parse(jsonStringResponse);

                if (historyRecords.error) {
                    console.error("Error loading usage history:", historyRecords.error);
                    showMessage("사용 내역 로딩 중 오류: " + historyRecords.error, false);
                    var row = tableBody.insertRow();
                    var cell = row.insertCell();
                    cell.colSpan = 4;
                    cell.textContent = "오류: " + historyRecords.error;
                    cell.style.textAlign = "center";
                    return;
                }

                if (!Array.isArray(historyRecords) || historyRecords.length === 0) {
                    var row = tableBody.insertRow();
                    var cell = row.insertCell();
                    cell.colSpan = 4;
                    cell.textContent = "사용 내역이 없습니다.";
                    cell.style.textAlign = "center";
                    return;
                }

                historyRecords.forEach(function(record) {
                    var row = tableBody.insertRow();
                    row.insertCell().textContent = formatReadableTimestamp(record.timestamp);
                    row.insertCell().textContent = record.barcode;
                    row.insertCell().textContent = typeof record.amountUsed === 'number' ? record.amountUsed.toFixed(2) : 'N/A';
                    row.insertCell().textContent = typeof record.newBalance === 'number' ? record.newBalance.toFixed(2) : 'N/A';
                });

            } catch (e) {
                console.error("Error parsing usage history response:", e, jsonStringResponse);
                showMessage("사용 내역 응답 처리 중 오류: " + e.message, false);
                var row = tableBody.insertRow();
                var cell = row.insertCell();
                cell.colSpan = 4;
                cell.textContent = "데이터 처리 중 오류가 발생했습니다.";
                cell.style.textAlign = "center";
            }
        })
        .withFailureHandler(function(error) {
            showLoading(false);
            tableBody.innerHTML = ''; // Clear loading message
            showMessage("사용 내역 로딩 중 서버 오류: " + error.message, false);
            console.error("Server error loading usage history:", error);
            var row = tableBody.insertRow();
            var cell = row.insertCell();
            cell.colSpan = 4;
            cell.textContent = "서버 통신 중 오류가 발생했습니다.";
            cell.style.textAlign = "center";
        })
        .getUsageHistory(barcodeToFilter);
  }

  function updateDashboard() {
    // Optional: Show a subtle loading indicator on the dashboard stats if needed
    // document.getElementById('totalCouponsStat').textContent = "로딩중...";
    // etc.

    google.script.run
      .withSuccessHandler(function(responseString) {
        try {
          var stats = JSON.parse(responseString);
          if (stats.error) {
            console.error("대시보드 통계 로딩 오류:", stats.error);
            // It might be better to show a generic error on the stat elements
            // or a specific error message via showMessage for critical errors.
            document.getElementById('totalCouponsStat').textContent = "오류";
            document.getElementById('availableCouponsStat').textContent = "오류";
            document.getElementById('expiringSoonStat').textContent = "오류";
            document.getElementById('totalBalanceStat').textContent = "오류";
            // showMessage("대시보드 통계 로딩 중 오류: " + stats.error, false); // Optional: if you want a banner
            return;
          }

          document.getElementById('totalCouponsStat').textContent = stats.totalCoupons + " 개";
          document.getElementById('availableCouponsStat').textContent = stats.availableCoupons + " 개";
          document.getElementById('expiringSoonStat').textContent = stats.expiringSoonCoupons + " 개";
          
          var balanceValue = parseFloat(stats.totalGiftCertificateBalance || 0);
          var formattedBalance = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(balanceValue);
          document.getElementById('totalBalanceStat').textContent = formattedBalance;

        } catch (e) {
          console.error("대시보드 통계 응답 파싱 오류:", e, responseString);
          document.getElementById('totalCouponsStat').textContent = "데이터 오류";
          document.getElementById('availableCouponsStat').textContent = "데이터 오류";
          document.getElementById('expiringSoonStat').textContent = "데이터 오류";
          document.getElementById('totalBalanceStat').textContent = "데이터 오류";
          // showMessage("대시보드 통계 응답 처리 중 오류: " + e.message, false); // Optional
        }
      })
      .withFailureHandler(function(error) {
        console.error("대시보드 통계 서버 호출 오류:", error);
        document.getElementById('totalCouponsStat').textContent = "서버 오류";
        document.getElementById('availableCouponsStat').textContent = "서버 오류";
        document.getElementById('expiringSoonStat').textContent = "서버 오류";
        document.getElementById('totalBalanceStat').textContent = "서버 오류";
        // showMessage("대시보드 통계 로딩 중 서버 통신 오류: " + error.message, false); // Optional
      })
      .getDashboardStats();
  }
</script>
</body>
</html>
